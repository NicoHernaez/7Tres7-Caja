<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7Tres7 - Panel de Caja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2/qz-tray.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•ü</text></svg>">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Order list */
        .order-row { transition: all 0.15s ease; }
        .order-row:hover { background: #eff6ff; }
        .order-row.selected { background: #dbeafe; border-left-color: #3b82f6 !important; }
        .order-row.late { animation: latePulse 2s infinite; }
        @keyframes latePulse { 0%, 100% { background: white; } 50% { background: #fef2f2; } }

        /* Detail panel animation */
        .detail-enter { animation: slideInRight 0.2s ease; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(8px); } to { opacity: 1; transform: translateX(0); } }

        /* Scrollbar */
        .order-list-scroll::-webkit-scrollbar, .detail-scroll::-webkit-scrollbar { width: 6px; }
        .order-list-scroll::-webkit-scrollbar-thumb, .detail-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .order-list-scroll::-webkit-scrollbar-thumb:hover, .detail-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Tab active */
        .tab-btn.active { background: #111827; color: white; }
        .mother-tab.active { color: white; border-bottom-color: #fb923c; }
        .sub-tab.active { background: #111827; color: white; }

        /* Animate pulse for late timers */
        .timer-pulse { animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <span class="text-6xl">ü•ü</span>
                <h1 class="text-3xl font-bold mt-4">7TRES7 CAJA</h1>
                <p class="text-gray-500">Panel de pedidos y caja</p>
            </div>
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center space-x-3 bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 hover:border-gray-400 transition">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    <span>Iniciar sesion con Google</span>
                </button>

                <div class="relative my-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">o</span></div>
                </div>

                <div id="magic-link-form">
                    <div class="flex space-x-2">
                        <input type="email" id="magic-email" class="flex-1 border rounded-lg px-4 py-3" placeholder="tu@email.com">
                        <button onclick="loginWithMagicLink()" class="bg-orange-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-orange-600 whitespace-nowrap">Enviar link</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">Te enviamos un link de acceso a tu email</p>
                </div>

                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                <p id="login-success" class="text-green-600 text-sm text-center hidden"></p>
                <p id="login-loading" class="text-gray-500 text-sm text-center hidden pulse">Verificando sesion...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-900 text-white px-4 py-2.5 flex items-center justify-between flex-shrink-0 z-20 shadow-lg">
            <div class="flex items-center space-x-3">
                <span class="text-xl">üî•</span>
                <h1 class="font-bold text-lg leading-tight">7TRES7 <span class="text-orange-400">CAJA</span></h1>
            </div>
            <div class="flex items-center space-x-4 text-sm">
                <div id="stats-bar" class="hidden md:flex items-center space-x-3 bg-gray-800 rounded-lg px-4 py-1.5">
                    <span>Hoy: <strong id="stat-revenue" class="text-green-400">$0</strong></span>
                    <span class="text-gray-600">|</span>
                    <span><strong id="stat-count" class="text-orange-400">0</strong> pedidos</span>
                    <span class="text-gray-600">|</span>
                    <span>Prom: <strong id="stat-avg" class="text-blue-400">$0</strong></span>
                    <span id="late-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse"></span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="openCierreCaja()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-3 py-2 rounded-lg transition" title="F12">CIERRE DE CAJA</button>
                <button onclick="diagnosticQZ()" class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2 hover:bg-gray-700 transition cursor-pointer" id="qz-status" title="Click para diagnostico QZ Tray">
                    <span id="qz-dot" class="w-2.5 h-2.5 rounded-full bg-red-500"></span>
                    <span class="text-xs" id="qz-label">QZ Tray</span>
                </button>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 px-3 py-2 rounded-lg hover:bg-gray-800 transition text-sm" title="Cerrar sesion">Salir</button>
            </div>
        </header>

        <!-- Mother Tabs (type of service) -->
        <div class="bg-gray-800 px-4 py-0 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center space-x-0" id="mother-tab-bar">
                <button class="mother-tab active text-sm font-bold px-5 py-2.5 text-white border-b-2 border-orange-400 transition" onclick="switchMotherTab('todos')" data-mtab="todos">Todos</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-400 border-b-2 border-transparent hover:text-white transition" onclick="switchMotherTab('mostrador')" data-mtab="mostrador">üè™ Mostrador</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-400 border-b-2 border-transparent hover:text-white transition" onclick="switchMotherTab('delivery')" data-mtab="delivery">üöö Delivery</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-500 border-b-2 border-transparent cursor-default opacity-50" disabled>üçΩÔ∏è Salon</button>
            </div>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <input type="text" id="search-input" class="bg-gray-700 border border-gray-600 text-white rounded-lg pl-8 pr-3 py-1.5 text-sm w-44 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400 placeholder-gray-400" placeholder="Buscar # o nombre..." oninput="onSearchInput(this.value)" title="F2">
                    <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
        </div>

        <!-- Sub Tabs (status within service type) -->
        <div class="bg-white border-b border-gray-200 px-4 py-1.5 flex items-center flex-shrink-0" style="min-height:40px;">
            <div class="flex items-center space-x-1" id="sub-tab-bar">
                <!-- Rendered dynamically by renderSubTabs() -->
            </div>
        </div>

        <!-- Master-Detail Layout -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Order List (left panel ~58%) -->
            <div class="w-[58%] flex flex-col border-r border-gray-200 bg-white">
                <div id="order-list" class="flex-1 overflow-y-auto order-list-scroll">
                    <!-- Order rows rendered here -->
                </div>
            </div>

            <!-- Order Detail (right panel ~42%) -->
            <div class="w-[42%] flex flex-col bg-gray-50">
                <div id="order-detail" class="flex-1 overflow-y-auto detail-scroll">
                    <!-- Detail rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cierre de Caja -->
    <div id="modal-cierre" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black bg-opacity-60" onclick="closeCierreCaja()"></div>
        <div class="absolute inset-4 md:inset-8 bg-white rounded-2xl shadow-2xl overflow-y-auto z-10">
            <div class="sticky top-0 bg-gray-900 text-white px-6 py-4 flex items-center justify-between rounded-t-2xl z-10">
                <h2 class="text-xl font-bold">Cierre de Caja</h2>
                <div class="flex items-center space-x-3">
                    <select id="cierre-turno" onchange="renderCierre()" class="bg-gray-800 text-white text-sm rounded-lg px-3 py-1.5 border border-gray-700">
                        <option value="all">Todo el dia</option>
                        <option value="noon">Mediodia (11-16hs)</option>
                        <option value="night">Noche (18-01hs)</option>
                    </select>
                    <button onclick="printCierreCaja()" class="bg-white text-gray-900 text-sm font-bold px-4 py-1.5 rounded-lg hover:bg-gray-100 transition">Imprimir</button>
                    <button onclick="closeCierreCaja()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div id="cierre-content" class="p-6"></div>
        </div>
    </div>

    <!-- Modal Staff Manager -->
    <div id="modal-staff" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeStaffManager()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden z-10">
            <div class="bg-gray-900 text-white px-5 py-4 flex items-center justify-between">
                <h2 class="font-bold text-lg">Administrar cadetes</h2>
                <button onclick="closeStaffManager()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-5 space-y-3">
                <div id="staff-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <div class="flex space-x-2 pt-2 border-t border-gray-200">
                    <input type="text" id="new-staff-name" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Nombre del cadete" onkeydown="if(event.key==='Enter')addStaffMember()">
                    <button onclick="addStaffMember()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Add Item -->
    <div id="modal-add-item" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeAddItemModal()"></div>
        <div class="absolute inset-y-8 left-1/2 -translate-x-1/2 w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden z-10 flex flex-col">
            <div class="bg-gray-900 text-white px-5 py-4 flex items-center justify-between flex-shrink-0">
                <h2 class="font-bold text-lg">Agregar producto al pedido</h2>
                <button onclick="closeAddItemModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="px-5 py-3 border-b flex-shrink-0">
                <input type="text" id="product-search-input" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Buscar producto..." oninput="filterProducts(this.value)">
            </div>
            <div id="product-grid" class="flex-1 overflow-y-auto p-5 grid grid-cols-2 sm:grid-cols-3 gap-3">
                <!-- Products rendered here -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACION ====================
        const SUPABASE_URL = 'https://yfdustfjfmifvgybwinr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmZHVzdGZqZm1pZnZneWJ3aW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzU3ODQsImV4cCI6MjA4NTgxMTc4NH0.YcLo7YXePi0_okJxtPuYLaMQI2-P4C8UxNzXnLfQoBY';
        const AUTHORIZED_EMAILS = ['nicohernaez22@gmail.com', 'lumimartin24@gmail.com', 'martinludmila300@gmail.com'];

        // Printer config
        const PRINTERS = { BARRA: 'Barra', MINUTA: 'Minuta', PARRILLA: 'Parrilla Delivery' };
        const QZ_HOSTS = { BARRA: '192.168.1.6', COCINA: '192.168.1.9' };
        const PRINTER_HOST_MAP = {
            [PRINTERS.BARRA]: QZ_HOSTS.BARRA,
            [PRINTERS.MINUTA]: QZ_HOSTS.COCINA,
            [PRINTERS.PARRILLA]: QZ_HOSTS.COCINA
        };
        const CATEGORY_PRINTER_MAP = {
            'empanadas': PRINTERS.MINUTA, 'minutas': PRINTERS.MINUTA, 'pizzas': PRINTERS.MINUTA, 'postres': PRINTERS.MINUTA,
            'restaurant': PRINTERS.PARRILLA, 'pastas': PRINTERS.PARRILLA, 'carnes': PRINTERS.PARRILLA, 'parrilla': PRINTERS.PARRILLA,
            'bebidas': PRINTERS.BARRA, 'gaseosas': PRINTERS.BARRA, 'cervezas': PRINTERS.BARRA, 'vinos': PRINTERS.BARRA
        };

        const PAY_LABELS = {
            'cash': 'Efectivo', 'debit_card': 'Tarj. Debito', 'credit_card': 'Tarj. Credito',
            'mercadopago': 'Mercado Pago', 'qr': 'QR', 'prepaid_card': 'Prepaga', 'transfer': 'Transferencia'
        };
        const PAY_ICONS = {
            'cash': 'üíµ', 'debit_card': 'üí≥', 'credit_card': 'üí≥',
            'mercadopago': 'üì≤', 'qr': 'üì±', 'prepaid_card': 'üí≥', 'transfer': 'üè¶'
        };

        let db = null;
        let currentUser = null;
        let appInitialized = false;
        let allOrders = [];
        let qzConnected = false;
        let realtimeChannel = null;
        let knownOrderIds = new Set();

        // UI state
        let selectedOrderId = null;
        let motherTab = 'todos';   // 'todos', 'mostrador', 'delivery'
        let subTab = 'pending';    // 'pending', 'preparing', 'delivering', 'delivered', 'cancelled'
        let searchQuery = '';
        let productsCache = [];
        let addItemOrderId = null;
        let deletingItemIndex = null; // Track which item is showing delete reason UI
        let staffCache = []; // cadetes, mozos, etc.

        // ==================== SUPABASE INIT ====================
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== AUTH ====================
        db.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event, session?.user?.email);
            const loading = document.getElementById('login-loading');
            const error = document.getElementById('login-error');

            if (session && !appInitialized) {
                const email = session.user.email;

                if (!AUTHORIZED_EMAILS.includes(email.toLowerCase())) {
                    await db.auth.signOut();
                    loading.classList.add('hidden');
                    error.textContent = 'Acceso denegado. El email ' + email + ' no esta autorizado.';
                    error.classList.remove('hidden');
                    return;
                }

                appInitialized = true;
                currentUser = session.user;
                error.classList.add('hidden');
                loading.classList.add('hidden');

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');

                initApp();
                showToast('Bienvenido a 7Tres7 Caja', 'success');

            } else if (event === 'SIGNED_OUT') {
                appInitialized = false;
                currentUser = null;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                loading.classList.add('hidden');
                if (realtimeChannel) {
                    db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
            }
        });

        // Fallback: hide loading if auth doesn't fire within 3s
        setTimeout(() => {
            if (!appInitialized) {
                document.getElementById('login-loading').classList.add('hidden');
            }
        }, 3000);

        async function loginWithGoogle() {
            const error = document.getElementById('login-error');
            error.classList.add('hidden');
            try {
                const { error: authError } = await db.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://7-tres7-caja.vercel.app'
                    }
                });
                if (authError) throw authError;
            } catch (e) {
                error.textContent = 'Error al iniciar sesion: ' + e.message;
                error.classList.remove('hidden');
            }
        }

        async function loginWithMagicLink() {
            const email = document.getElementById('magic-email').value.trim();
            const error = document.getElementById('login-error');
            const success = document.getElementById('login-success');
            error.classList.add('hidden');
            success.classList.add('hidden');

            if (!email) { error.textContent = 'Ingresa tu email'; error.classList.remove('hidden'); return; }
            if (!AUTHORIZED_EMAILS.includes(email)) { error.textContent = 'El email ' + email + ' no esta autorizado.'; error.classList.remove('hidden'); return; }

            try {
                const { error: authError } = await db.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.href.split('#')[0].split('?')[0]
                    }
                });
                if (authError) throw authError;
                success.textContent = 'Link enviado a ' + email + '. Revisa tu bandeja de entrada.';
                success.classList.remove('hidden');
            } catch (e) {
                error.textContent = 'Error: ' + e.message;
                error.classList.remove('hidden');
            }
        }

        async function logout() {
            if (!confirm('Cerrar sesion?')) return;
            await db.auth.signOut();
        }

        // ==================== APP INIT ====================
        async function initApp() {
            await Promise.all([loadOrders(), loadStaff()]);
            subscribeToOrders();
            connectQZ();
        }

        async function loadStaff() {
            try {
                const { data, error } = await db.from('staff').select('id, name, role, phone, is_active').eq('is_active', true).order('name');
                if (error) throw error;
                staffCache = data || [];
            } catch (e) {
                console.error('Error loading staff:', e);
            }
        }

        // ==================== LOAD ORDERS ====================
        function getTodayStart() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d.toISOString();
        }

        async function loadOrders() {
            try {
                const todayStart = getTodayStart();
                const { data, error } = await db
                    .from('orders')
                    .select('*, customers(name, phone)')
                    .gte('created_at', todayStart)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allOrders = data || [];
                allOrders.forEach(o => knownOrderIds.add(o.id));
                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error loading orders:', e);
                showToast('Error cargando pedidos: ' + e.message, 'error');
            }
        }

        // ==================== REALTIME ====================
        function subscribeToOrders() {
            if (realtimeChannel) {
                db.removeChannel(realtimeChannel);
            }

            realtimeChannel = db
                .channel('orders-caja')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'orders'
                }, (payload) => {
                    console.log('Realtime event:', payload.eventType, payload.new?.order_number);
                    handleRealtimeEvent(payload);
                })
                .subscribe((status) => {
                    console.log('Realtime status:', status);
                });
        }

        function handleRealtimeEvent(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            const todayStart = getTodayStart();

            if (eventType === 'INSERT') {
                if (newRecord.created_at >= todayStart) {
                    const isNew = !knownOrderIds.has(newRecord.id);
                    knownOrderIds.add(newRecord.id);

                    const existingIdx = allOrders.findIndex(o => o.id === newRecord.id);
                    if (existingIdx >= 0) {
                        allOrders[existingIdx] = newRecord;
                    } else {
                        allOrders.unshift(newRecord);
                    }

                    if (isNew) {
                        playNotificationSound();
                    }
                }
            } else if (eventType === 'UPDATE') {
                const idx = allOrders.findIndex(o => o.id === newRecord.id);
                if (idx >= 0) {
                    allOrders[idx] = newRecord;
                } else if (newRecord.created_at >= todayStart) {
                    allOrders.unshift(newRecord);
                }
            } else if (eventType === 'DELETE') {
                allOrders = allOrders.filter(o => o.id !== (oldRecord?.id || ''));
                if (selectedOrderId === oldRecord?.id) selectedOrderId = null;
            }

            renderOrderList();
            renderOrderDetail();
            updateStats();
        }

        // ==================== NOTIFICATION SOUND ====================
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc1 = ctx.createOscillator();
                const gain1 = ctx.createGain();
                osc1.connect(gain1);
                gain1.connect(ctx.destination);
                osc1.frequency.value = 880;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, ctx.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc1.start(ctx.currentTime);
                osc1.stop(ctx.currentTime + 0.2);

                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.frequency.value = 1100;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, ctx.currentTime + 0.25);
                gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc2.start(ctx.currentTime + 0.25);
                osc2.stop(ctx.currentTime + 0.5);

                setTimeout(() => ctx.close(), 1000);
            } catch (e) {
                console.warn('Could not play notification sound:', e);
            }
        }

        // ==================== TIME HELPERS ====================
        // Timer: for preparing+ orders, clock starts at confirmed_at
        // Late threshold: 40min for delivery, no late for pickup (their problem)
        function getTimeInfo(order) {
            // For pending orders, show time since creation
            const ref = order.status === 'pending' ? order.created_at : (order.confirmed_at || order.created_at);
            const minutes = Math.floor((Date.now() - new Date(ref)) / 60000);
            const isDelivery = order.delivery_type === 'delivery';
            const lateThreshold = 40; // minutes

            if (order.status === 'pending') {
                // Pending: just show wait time, yellow if > 5min
                if (minutes < 5) return { label: minutes + 'm', color: 'text-gray-500', bg: 'bg-gray-50', pulse: false, minutes };
                return { label: minutes + 'm', color: 'text-yellow-600', bg: 'bg-yellow-50', pulse: minutes > 10, minutes };
            }

            // For delivery orders: green < 20m, yellow < 30m, orange < 40m, red >= 40m
            if (isDelivery) {
                if (minutes < 20) return { label: minutes + 'm', color: 'text-green-600', bg: 'bg-green-50', pulse: false, minutes };
                if (minutes < 30) return { label: minutes + 'm', color: 'text-yellow-600', bg: 'bg-yellow-50', pulse: false, minutes };
                if (minutes < lateThreshold) return { label: minutes + 'm', color: 'text-orange-600', bg: 'bg-orange-50', pulse: false, minutes };
                return { label: minutes + 'm', color: 'text-red-600 font-bold', bg: 'bg-red-50', pulse: true, minutes };
            }

            // For mostrador: green < 20m, yellow < 30m, orange after. No red (their problem).
            if (minutes < 20) return { label: minutes + 'm', color: 'text-green-600', bg: 'bg-green-50', pulse: false, minutes };
            if (minutes < 30) return { label: minutes + 'm', color: 'text-yellow-600', bg: 'bg-yellow-50', pulse: false, minutes };
            return { label: minutes + 'm', color: 'text-orange-600', bg: 'bg-orange-50', pulse: false, minutes };
        }

        function getElapsedLabel(fromDate) {
            if (!fromDate) return '';
            const minutes = Math.floor((Date.now() - new Date(fromDate)) / 60000);
            if (minutes < 1) return 'hace un momento';
            if (minutes < 60) return 'hace ' + minutes + 'm';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return 'hace ' + hours + 'h ' + mins + 'm';
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        function fmt(n) {
            return '$' + parseFloat(n || 0).toLocaleString('es-AR');
        }

        // ==================== MOTHER TAB & SUB TAB LOGIC ====================

        // Orders filtered by mother tab (delivery type)
        function getMotherOrders() {
            if (motherTab === 'mostrador') return allOrders.filter(o => o.delivery_type === 'pickup');
            if (motherTab === 'delivery') return allOrders.filter(o => o.delivery_type === 'delivery');
            return allOrders; // 'todos'
        }

        // Sub tabs depend on mother tab
        // Listo = Entregado (cuando se marca listo, va directo a entregado en mostrador)
        // Delivery tiene paso extra: Enviados (delivering)
        function getSubTabDefs() {
            if (motherTab === 'mostrador') {
                return [
                    { id: 'pending', label: 'Pendientes', filter: o => o.status === 'pending' },
                    { id: 'preparing', label: 'Preparando', filter: o => o.status === 'confirmed' || o.status === 'preparing' },
                    { id: 'delivered', label: 'Entregados', filter: o => o.status === 'ready' || o.status === 'delivered' },
                    { id: 'cancelled', label: 'Cancelados', filter: o => o.status === 'cancelled' }
                ];
            }
            if (motherTab === 'delivery') {
                return [
                    { id: 'pending', label: 'Pendientes', filter: o => o.status === 'pending' },
                    { id: 'preparing', label: 'Preparando', filter: o => o.status === 'confirmed' || o.status === 'preparing' },
                    { id: 'delivering', label: 'Enviados', filter: o => o.status === 'ready' || o.status === 'delivering' },
                    { id: 'delivered', label: 'Entregados', filter: o => o.status === 'delivered' },
                    { id: 'cancelled', label: 'Cancelados', filter: o => o.status === 'cancelled' }
                ];
            }
            // todos
            return [
                { id: 'pending', label: 'Pendientes', filter: o => o.status === 'pending' },
                { id: 'preparing', label: 'Preparando', filter: o => o.status === 'confirmed' || o.status === 'preparing' },
                { id: 'delivering', label: 'Enviados', filter: o => o.status === 'ready' || o.status === 'delivering' },
                { id: 'delivered', label: 'Entregados', filter: o => o.status === 'delivered' },
                { id: 'cancelled', label: 'Cancelados', filter: o => o.status === 'cancelled' }
            ];
        }

        function renderSubTabs() {
            const defs = getSubTabDefs();
            const mo = getMotherOrders();
            const bar = document.getElementById('sub-tab-bar');
            bar.innerHTML = defs.map(d => {
                const count = mo.filter(d.filter).length;
                const isActive = subTab === d.id;
                return `<button class="sub-tab ${isActive ? 'active' : ''} text-sm font-medium px-3 py-1 rounded-lg transition ${isActive ? '' : 'text-gray-600 hover:bg-gray-100'}" onclick="switchSubTab('${d.id}')" data-stab="${d.id}">${d.label} (${count})</button>`;
            }).join('');
        }

        function switchMotherTab(tab) {
            motherTab = tab;
            // Update mother tab UI
            document.querySelectorAll('.mother-tab').forEach(btn => {
                if (btn.dataset.mtab === tab) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-400');
                    btn.style.borderBottomColor = '#fb923c';
                } else if (!btn.disabled) {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-400');
                    btn.style.borderBottomColor = 'transparent';
                }
            });
            // Reset sub tab to 'pending' if current sub tab doesn't exist in this mother tab
            const defs = getSubTabDefs();
            if (!defs.find(d => d.id === subTab)) subTab = 'pending';
            renderSubTabs();
            renderOrderList();
            renderOrderDetail();
        }

        function switchSubTab(tab) {
            subTab = tab;
            renderSubTabs();
            renderOrderList();
            renderOrderDetail();
        }

        // Keep backward compat alias
        function switchTab(tab) { switchSubTab(tab); }

        function onSearchInput(val) {
            searchQuery = val.trim().toLowerCase();
            renderOrderList();
        }

        function getFilteredOrders() {
            let orders = getMotherOrders();

            // Sub tab filter
            const defs = getSubTabDefs();
            const activeDef = defs.find(d => d.id === subTab);
            if (activeDef) {
                orders = orders.filter(activeDef.filter);
            }

            // Search filter
            if (searchQuery) {
                orders = orders.filter(o => {
                    const num = String(o.order_number || '').toLowerCase();
                    const name = (o.customer_name || extractFromNotes(o.customer_notes, 'Nombre') || '').toLowerCase();
                    const phone = (o.customer_phone || extractFromNotes(o.customer_notes, 'Tel') || '').toLowerCase();
                    return num.includes(searchQuery) || name.includes(searchQuery) || phone.includes(searchQuery);
                });
            }

            // Sorting
            if (subTab === 'delivered') {
                orders.sort((a, b) => new Date(b.delivered_at || b.created_at) - new Date(a.delivered_at || a.created_at));
            } else if (subTab === 'cancelled') {
                orders.sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
            } else {
                // Active orders: oldest first (most urgent on top)
                orders.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            }

            return orders;
        }

        // ==================== RENDER ORDER LIST ====================
        function renderOrderList() {
            renderSubTabs();
            const orders = getFilteredOrders();
            const container = document.getElementById('order-list');

            if (orders.length === 0) {
                const emojis = { active: 'üìã', pending: '‚è≥', preparing: 'üç≥', ready: '‚úÖ', delivering: 'üöö', delivered: 'üì¶', cancelled: '‚ùå' };
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <span class="text-4xl mb-3">${emojis[subTab] || 'üìã'}</span>
                        <span class="text-sm">Sin pedidos${searchQuery ? ' para "' + searchQuery + '"' : ''}</span>
                    </div>`;
                return;
            }

            container.innerHTML = orders.map(o => renderOrderRow(o)).join('');
        }

        function renderOrderRow(order) {
            const isSelected = order.id === selectedOrderId;
            const isDelivery = order.delivery_type === 'delivery';
            const customerName = order.customer_name || extractFromNotes(order.customer_notes, 'Nombre') || '';
            const total = fmt(order.total);

            // Status border color
            let borderColor = 'border-l-gray-300';
            if (order.status === 'pending') borderColor = 'border-l-yellow-400';
            else if (order.status === 'confirmed' || order.status === 'preparing') borderColor = 'border-l-orange-400';
            else if (order.status === 'ready') borderColor = 'border-l-green-400';
            else if (order.status === 'delivering') borderColor = 'border-l-blue-400';
            else if (order.status === 'delivered') borderColor = 'border-l-gray-300';
            else if (order.status === 'cancelled') borderColor = 'border-l-red-400';

            // Time info
            const isActive = ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status);
            let timeHTML = '';
            let isLate = false;
            if (isActive) {
                const ti = getTimeInfo(order);
                isLate = ti.pulse;
                timeHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${ti.bg} ${ti.color} w-14 text-center ${ti.pulse ? 'timer-pulse' : ''}" data-order-id="${order.id}">${ti.label}</span>`;
            } else if (order.status === 'delivered') {
                const deliveredTime = formatTime(order.delivered_at);
                timeHTML = `<span class="text-xs text-gray-400 w-14 text-center">${deliveredTime || '‚úÖ'}</span>`;
            } else if (order.status === 'cancelled') {
                timeHTML = `<span class="text-xs text-red-400 w-14 text-center">‚úï</span>`;
            }

            // Quick action button - contextual by status and delivery type
            // Mostrador: Pendiente > Preparando > Entregado (listo = entregado)
            // Delivery:  Pendiente > Preparando > Enviado > Entregado
            let quickBtn = '';
            if (order.status === 'pending') {
                quickBtn = `<button onclick="event.stopPropagation(); confirmOrder('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded bg-green-500 text-white hover:bg-green-600 w-24 transition">CONFIRMAR</button>`;
            } else if (order.status === 'confirmed' || order.status === 'preparing') {
                if (isDelivery) {
                    quickBtn = `<button onclick="event.stopPropagation(); markReady('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded bg-purple-500 text-white hover:bg-purple-600 w-24 transition">LISTO</button>`;
                } else {
                    quickBtn = `<button onclick="event.stopPropagation(); markDelivered('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded bg-green-500 text-white hover:bg-green-600 w-24 transition">ENTREGADO</button>`;
                }
            } else if (order.status === 'ready' && isDelivery) {
                quickBtn = `<button onclick="event.stopPropagation(); markDelivering('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded bg-blue-500 text-white hover:bg-blue-600 w-24 transition">ENVIADO</button>`;
            } else if (order.status === 'delivering') {
                quickBtn = `<button onclick="event.stopPropagation(); markDelivered('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded bg-green-500 text-white hover:bg-green-600 w-24 transition">ENTREGADO</button>`;
            }

            const deliveredClass = order.status === 'delivered' ? 'opacity-60' : '';
            const cancelledClass = order.status === 'cancelled' ? 'opacity-60' : '';
            const totalClass = order.status === 'cancelled' ? 'line-through text-red-500' : 'text-gray-900';

            return `
            <div class="order-row flex items-center px-3 py-2.5 border-b border-gray-100 cursor-pointer border-l-4 ${borderColor} ${isSelected ? 'selected' : ''} ${isLate && !isSelected ? 'late' : ''} ${deliveredClass} ${cancelledClass}"
                 onclick="selectOrder('${order.id}')">
                <span class="font-bold text-base w-14 text-gray-900">#${order.order_number || '---'}</span>
                <span class="w-7 text-center text-sm">${isDelivery ? 'üöö' : 'üè™'}</span>
                <span class="flex-1 truncate text-sm text-gray-700 px-2">${customerName || '‚Äî'}${isDelivery && order.assigned_to ? ` <span class="text-xs text-blue-500">¬∑ ${order.assigned_to}</span>` : ''}</span>
                ${timeHTML}
                <span class="font-bold text-sm w-20 text-right ${totalClass}">${total}</span>
                ${quickBtn}
            </div>`;
        }

        // ==================== RENDER ORDER DETAIL ====================
        function renderOrderDetail() {
            const container = document.getElementById('order-detail');

            if (!selectedOrderId) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="text-base font-medium">Selecciona un pedido de la lista</p>
                        <p class="text-sm mt-1">Usa las flechas o haz click en un pedido</p>
                    </div>`;
                return;
            }

            const order = allOrders.find(o => o.id === selectedOrderId);
            if (!order) {
                selectedOrderId = null;
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <p class="text-sm">Pedido no encontrado</p>
                    </div>`;
                return;
            }

            const isDelivery = order.delivery_type === 'delivery';
            const customerName = order.customer_name || order.customers?.name || extractFromNotes(order.customer_notes, 'Nombre') || '';
            const customerPhone = order.customer_phone || order.customers?.phone || extractFromNotes(order.customer_notes, 'Tel') || '';
            const address = isDelivery ? (order.delivery_address || '') : '';
            const items = order.items || [];

            // Status badge
            const statusMap = {
                'pending': { label: 'PENDIENTE', bg: 'bg-yellow-100', text: 'text-yellow-800' },
                'confirmed': { label: 'CONFIRMADO', bg: 'bg-blue-100', text: 'text-blue-800' },
                'preparing': { label: 'PREPARANDO', bg: 'bg-orange-100', text: 'text-orange-800' },
                'ready': { label: 'LISTO', bg: 'bg-green-100', text: 'text-green-800' },
                'delivering': { label: 'ENVIADO', bg: 'bg-blue-100', text: 'text-blue-800' },
                'delivered': { label: 'ENTREGADO', bg: 'bg-gray-100', text: 'text-gray-600' },
                'cancelled': { label: 'CANCELADO', bg: 'bg-red-100', text: 'text-red-800' }
            };
            const st = statusMap[order.status] || statusMap['pending'];

            // Time info - shows timer for active orders
            const isActive = ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status);
            let timeSection = '';
            if (isActive) {
                const ti = getTimeInfo(order);
                timeSection = `<span class="text-lg font-bold ${ti.color} ${ti.pulse ? 'timer-pulse' : ''}">${ti.label}</span>`;
            }

            // Items HTML
            const itemsHTML = items.map((item, idx) => {
                const itemSubtotal = fmt(item.subtotal || (item.price * item.quantity) || 0);
                let obsLine = '';
                if (item.obs) obsLine += `<p class="text-xs text-gray-400 italic ml-7">obs: ${item.obs}</p>`;
                if (item.cooking_method) {
                    const cm = item.cooking_method === 'frito' ? 'Frita' : item.cooking_method === 'horno' ? 'Al Horno' : item.cooking_method;
                    obsLine += `<p class="text-xs text-orange-500 ml-7">[${cm}]</p>`;
                }

                // Delete reason UI (inline)
                let deleteReasonHTML = '';
                if (deletingItemIndex === idx && selectedOrderId === order.id) {
                    deleteReasonHTML = `
                        <div class="ml-7 mt-1 flex items-center space-x-2 bg-red-50 rounded px-2 py-1.5">
                            <span class="text-xs text-red-600 font-medium whitespace-nowrap">Motivo?</span>
                            <select id="delete-reason-${idx}" class="text-xs border border-red-200 rounded px-2 py-1 bg-white flex-1">
                                <option value="Cliente cancelo">Cliente cancelo</option>
                                <option value="Sin stock">Sin stock</option>
                                <option value="Error de carga">Error de carga</option>
                                <option value="Cambio de pedido">Cambio de pedido</option>
                            </select>
                            <button onclick="confirmRemoveItem('${order.id}', ${idx})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 font-bold">Eliminar</button>
                            <button onclick="cancelDeleteItem()" class="text-xs text-gray-500 hover:text-gray-700">&times;</button>
                        </div>`;
                }

                const isEditable = !['delivered', 'cancelled', 'delivering'].includes(order.status);

                return `
                <div class="py-2 ${idx > 0 ? 'border-t border-gray-100' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            <span class="font-semibold text-sm w-7 text-gray-900">${item.quantity}x</span>
                            <span class="text-sm text-gray-800 truncate">${item.name}</span>
                        </div>
                        <span class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">${itemSubtotal}</span>
                    </div>
                    ${obsLine}
                    ${isEditable ? `
                    <div class="ml-7 mt-1 flex items-center space-x-1">
                        <button onclick="editItemQuantity('${order.id}', ${idx}, 1)" class="w-6 h-6 flex items-center justify-center rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm font-bold transition" title="Agregar 1">+</button>
                        <button onclick="editItemQuantity('${order.id}', ${idx}, -1)" class="w-6 h-6 flex items-center justify-center rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm font-bold transition" title="Quitar 1">&minus;</button>
                        <button onclick="startDeleteItem(${idx})" class="w-6 h-6 flex items-center justify-center rounded bg-red-50 hover:bg-red-100 text-red-500 text-xs transition" title="Eliminar item">üóëÔ∏è</button>
                    </div>
                    ` : ''}
                    ${deleteReasonHTML}
                </div>`;
            }).join('');

            // Totals
            const subtotal = items.reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);
            const discount = parseFloat(order.discount || 0);
            const total = parseFloat(order.total || 0);

            // Main action button - contextual by status and delivery type
            // Mostrador: Pendiente > Preparando > Entregado
            // Delivery:  Pendiente > Preparando > Listo > Enviado > Entregado
            let mainActionHTML = '';
            if (order.status === 'pending') {
                mainActionHTML = `<button onclick="confirmOrder('${order.id}')" class="w-full py-3 rounded-lg text-white font-bold text-sm bg-green-500 hover:bg-green-600 transition">‚úì CONFIRMAR PEDIDO</button>`;
            } else if (order.status === 'confirmed' || order.status === 'preparing') {
                if (isDelivery) {
                    mainActionHTML = `<button onclick="markReady('${order.id}')" class="w-full py-3 rounded-lg text-white font-bold text-sm bg-purple-500 hover:bg-purple-600 transition">‚úì MARCAR LISTO</button>`;
                } else {
                    mainActionHTML = `<button onclick="markDelivered('${order.id}')" class="w-full py-3 rounded-lg text-white font-bold text-sm bg-green-500 hover:bg-green-600 transition">‚úì MARCAR ENTREGADO</button>`;
                }
            } else if (order.status === 'ready' && isDelivery) {
                mainActionHTML = `<button onclick="markDelivering('${order.id}')" class="w-full py-3 rounded-lg text-white font-bold text-sm bg-blue-500 hover:bg-blue-600 transition">üöö MARCAR ENVIADO</button>`;
            } else if (order.status === 'delivering') {
                mainActionHTML = `<button onclick="markDelivered('${order.id}')" class="w-full py-3 rounded-lg text-white font-bold text-sm bg-green-500 hover:bg-green-600 transition">‚úì MARCAR ENTREGADO</button>`;
            }

            // Timeline
            let timelineHTML = '';
            const timelineSteps = [];
            if (order.created_at) timelineSteps.push({ label: 'Creado', time: order.created_at });
            if (order.confirmed_at) timelineSteps.push({ label: 'Confirmado', time: order.confirmed_at });
            if (order.ready_at) timelineSteps.push({ label: 'Listo', time: order.ready_at });
            if (order.delivering_at) timelineSteps.push({ label: 'Enviado', time: order.delivering_at });
            if (order.delivered_at) timelineSteps.push({ label: 'Entregado', time: order.delivered_at });

            timelineHTML = timelineSteps.map(s => {
                return `<div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${s.label}</span>
                    <span>${formatTime(s.time)} (${getElapsedLabel(s.time)})</span>
                </div>`;
            }).join('');

            const canEdit = !['delivered', 'cancelled', 'delivering'].includes(order.status);

            container.innerHTML = `
            <div class="detail-enter">
                <!-- Header -->
                <div class="px-5 pt-5 pb-3 bg-white border-b border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-bold text-gray-900">#${order.order_number || '---'}</span>
                            <span class="text-xs font-bold px-2.5 py-1 rounded-full ${st.bg} ${st.text}">${st.label}</span>
                        </div>
                        ${timeSection}
                    </div>
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-sm font-bold ${isDelivery ? 'text-blue-600' : 'text-green-600'}">${isDelivery ? 'üöö DELIVERY' : 'üè™ RETIRA EN LOCAL'}</span>
                    </div>
                    ${address ? `<p class="text-sm text-gray-600 mb-0.5">${address}</p>` : ''}
                    ${customerName ? `<p class="text-sm text-gray-700 font-medium">${customerName}</p>` : ''}
                    ${customerPhone ? `<p class="text-sm text-gray-500"><a href="tel:${customerPhone}" class="hover:text-blue-600 underline decoration-dotted">${customerPhone}</a></p>` : ''}
                </div>

                <!-- Items -->
                <div class="px-5 py-3 bg-white border-b border-gray-200">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Items</h3>
                    ${itemsHTML || '<p class="text-sm text-gray-400">Sin items</p>'}
                    ${canEdit ? `
                    <button onclick="openAddItemModal('${order.id}')" class="mt-3 w-full py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50 transition">+ Agregar item</button>
                    ` : ''}
                </div>

                <!-- Totals + Discount -->
                <div class="px-5 py-3 bg-white border-b border-gray-200">
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span>${fmt(subtotal)}</span>
                        </div>
                        ${deliveryFee > 0 ? `
                        <div class="flex justify-between text-sm text-blue-600">
                            <span>Envio</span>
                            <span>${fmt(deliveryFee)}</span>
                        </div>` : ''}
                        ${discount > 0 ? `
                        <div class="flex justify-between text-sm text-red-500">
                            <span>Descuento${order.discount_reason ? ' (' + order.discount_reason + ')' : ''}</span>
                            <span>-${fmt(discount)}</span>
                        </div>` : ''}
                        <div class="flex justify-between text-lg font-bold text-gray-900 pt-1 border-t border-gray-200">
                            <span>TOTAL</span>
                            <span>${fmt(total)}</span>
                        </div>
                    </div>
                    ${canEdit ? `
                    <div class="mt-3 pt-2 border-t border-gray-100">
                        ${discount > 0 ? `
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-red-500 font-medium">Descuento aplicado: -${fmt(discount)}</span>
                            <button onclick="removeDiscount('${order.id}')" class="text-xs text-red-500 hover:text-red-700 underline">Quitar</button>
                        </div>
                        ` : `
                        <div id="discount-form-${order.id}">
                            <button onclick="showDiscountForm('${order.id}')" class="w-full py-1.5 text-xs font-medium text-orange-600 border border-orange-200 rounded-lg hover:bg-orange-50 transition">Aplicar descuento</button>
                        </div>
                        `}
                    </div>
                    ` : ''}
                </div>

                <!-- Payment -->
                <div class="px-5 py-3 bg-white border-b border-gray-200">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Medio de pago</h3>
                    <select onchange="updatePaymentMethod('${order.id}', this.value)" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">
                        <option value="cash" ${order.payment_method === 'cash' ? 'selected' : ''}>üíµ Efectivo</option>
                        <option value="debit_card" ${order.payment_method === 'debit_card' ? 'selected' : ''}>üí≥ Tarj. Debito</option>
                        <option value="credit_card" ${order.payment_method === 'credit_card' ? 'selected' : ''}>üí≥ Tarj. Credito</option>
                        <option value="mercadopago" ${order.payment_method === 'mercadopago' ? 'selected' : ''}>üì≤ Mercado Pago</option>
                        <option value="qr" ${order.payment_method === 'qr' ? 'selected' : ''}>üì± QR</option>
                        <option value="prepaid_card" ${order.payment_method === 'prepaid_card' ? 'selected' : ''}>üí≥ Prepaga</option>
                        <option value="transfer" ${order.payment_method === 'transfer' ? 'selected' : ''}>üè¶ Transferencia</option>
                    </select>
                </div>

                <!-- Cadete / Mozo assignment -->
                ${isDelivery ? `
                <div class="px-5 py-3 bg-white border-b border-gray-200">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Cadete asignado</h3>
                    <div class="flex items-center space-x-2">
                        <select onchange="assignStaff('${order.id}', this.value)" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <option value="">Sin asignar</option>
                            ${staffCache.filter(s => s.role === 'cadete').map(s => `<option value="${s.name}" ${order.assigned_to === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                        <button onclick="openStaffManager()" class="px-2 py-2 text-gray-400 hover:text-blue-600 transition" title="Administrar cadetes">‚öôÔ∏è</button>
                    </div>
                </div>
                ` : ''}

                <!-- Timeline -->
                <div class="px-5 py-3 bg-white border-b border-gray-200">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Historial</h3>
                    <div class="space-y-1">
                        ${timelineHTML}
                    </div>
                </div>

                <!-- Actions -->
                <div class="px-5 py-4 bg-white">
                    ${mainActionHTML ? `<div class="mb-3">${mainActionHTML}</div>` : ''}
                    <div class="flex items-center space-x-2 mb-3">
                        <button onclick="printOrder('${order.id}')" class="flex-1 py-2.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">üñ®Ô∏è Imprimir</button>
                        <button onclick="notifyCustomerWhatsApp('${order.id}', '${order_whatsapp_event(order.status)}')" class="flex-1 py-2.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">üí¨ WhatsApp</button>
                    </div>
                    ${order.status !== 'cancelled' && order.status !== 'delivered' ? `
                    <button onclick="cancelOrder('${order.id}')" class="w-full py-2 text-sm font-medium text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition">‚ùå Cancelar pedido</button>
                    ` : ''}
                </div>
            </div>`;
        }

        function order_whatsapp_event(status) {
            if (status === 'pending') return 'confirmed';
            if (status === 'confirmed' || status === 'preparing') return 'ready';
            if (status === 'ready') return 'delivering';
            if (status === 'delivering') return 'delivering';
            return 'ready';
        }

        // ==================== SELECT ORDER ====================
        function selectOrder(orderId) {
            selectedOrderId = orderId;
            deletingItemIndex = null;
            renderOrderList();
            renderOrderDetail();
        }

        function selectNextOrder() {
            const orders = getFilteredOrders();
            if (orders.length === 0) return;
            if (!selectedOrderId) {
                selectOrder(orders[0].id);
                return;
            }
            const idx = orders.findIndex(o => o.id === selectedOrderId);
            if (idx < orders.length - 1) {
                selectOrder(orders[idx + 1].id);
            }
        }

        function selectPrevOrder() {
            const orders = getFilteredOrders();
            if (orders.length === 0) return;
            if (!selectedOrderId) {
                selectOrder(orders[0].id);
                return;
            }
            const idx = orders.findIndex(o => o.id === selectedOrderId);
            if (idx > 0) {
                selectOrder(orders[idx - 1].id);
            }
        }

        // ==================== ITEM EDITING ====================
        async function editItemQuantity(orderId, itemIndex, delta) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) return;

            const items = [...order.items];
            items[itemIndex] = { ...items[itemIndex] };
            items[itemIndex].quantity = Math.max(1, (items[itemIndex].quantity || 1) + delta);
            items[itemIndex].subtotal = items[itemIndex].quantity * (items[itemIndex].price || 0);

            await updateOrderInDB(orderId, items);
        }

        function startDeleteItem(itemIndex) {
            deletingItemIndex = itemIndex;
            renderOrderDetail();
        }

        function cancelDeleteItem() {
            deletingItemIndex = null;
            renderOrderDetail();
        }

        async function confirmRemoveItem(orderId, itemIndex) {
            const reasonEl = document.getElementById('delete-reason-' + itemIndex);
            const reason = reasonEl ? reasonEl.value : 'Sin motivo';

            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) return;

            const removedItem = order.items[itemIndex];
            console.log('Item eliminado:', removedItem.name, '| Motivo:', reason, '| Pedido #' + order.order_number);

            const items = order.items.filter((_, i) => i !== itemIndex);
            deletingItemIndex = null;

            await updateOrderInDB(orderId, items);
            showToast('Item eliminado: ' + removedItem.name, 'info');
        }

        async function updateOrderInDB(orderId, newItems) {
            try {
                // Recalculate total
                const order = allOrders.find(o => o.id === orderId);
                if (!order) return;

                const subtotal = newItems.reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
                const deliveryFee = parseFloat(order.delivery_fee || 0);
                const discount = parseFloat(order.discount || 0);
                const newTotal = subtotal + deliveryFee - discount;

                const { error } = await db.from('orders').update({
                    items: newItems,
                    subtotal: subtotal,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                // Update local state
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].items = newItems;
                    allOrders[idx].subtotal = subtotal;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error al actualizar: ' + e.message, 'error');
            }
        }

        // ==================== DISCOUNT ====================
        function showDiscountForm(orderId) {
            const container = document.getElementById('discount-form-' + orderId);
            if (!container) return;
            container.innerHTML = `
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 space-y-2">
                    <div class="flex space-x-2">
                        <label class="flex items-center space-x-1 text-xs cursor-pointer">
                            <input type="radio" name="disc-type-${orderId}" value="percent" checked class="accent-orange-500"> <span>%</span>
                        </label>
                        <label class="flex items-center space-x-1 text-xs cursor-pointer">
                            <input type="radio" name="disc-type-${orderId}" value="fixed" class="accent-orange-500"> <span>$ Fijo</span>
                        </label>
                    </div>
                    <input type="number" id="disc-value-${orderId}" min="0" step="any" placeholder="Valor" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300">
                    <input type="text" id="disc-reason-${orderId}" placeholder="Motivo (opcional)" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300">
                    <div class="flex space-x-2">
                        <button onclick="applyDiscount('${orderId}')" class="flex-1 py-1.5 text-xs font-bold text-white bg-orange-500 hover:bg-orange-600 rounded-lg transition">Aplicar</button>
                        <button onclick="renderOrderDetail()" class="flex-1 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    </div>
                </div>`;
            document.getElementById('disc-value-' + orderId).focus();
        }

        async function applyDiscount(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const typeRadio = document.querySelector(`input[name="disc-type-${orderId}"]:checked`);
            const discType = typeRadio ? typeRadio.value : 'percent';
            const rawValue = parseFloat(document.getElementById('disc-value-' + orderId).value);
            const reason = (document.getElementById('disc-reason-' + orderId).value || '').trim();

            if (!rawValue || rawValue <= 0) {
                showToast('Ingresa un valor de descuento', 'error');
                return;
            }

            const subtotal = (order.items || []).reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);

            let discount;
            if (discType === 'percent') {
                if (rawValue > 100) { showToast('El porcentaje no puede ser mayor a 100%', 'error'); return; }
                discount = Math.round(subtotal * rawValue / 100);
            } else {
                discount = rawValue;
            }

            const baseTotal = subtotal + deliveryFee;
            if (discount > baseTotal) { showToast('El descuento supera el total', 'error'); return; }

            const newTotal = baseTotal - discount;
            const discountReason = discType === 'percent' ? `${rawValue}%${reason ? ' - ' + reason : ''}` : (reason || '');

            try {
                const { error } = await db.from('orders').update({
                    discount: discount,
                    discount_reason: discountReason,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].discount = discount;
                    allOrders[idx].discount_reason = discountReason;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
                showToast(`Descuento de ${fmt(discount)} aplicado`, 'success');
            } catch (e) {
                console.error('Error applying discount:', e);
                showToast('Error al aplicar descuento: ' + e.message, 'error');
            }
        }

        async function removeDiscount(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const subtotal = (order.items || []).reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);
            const newTotal = subtotal + deliveryFee;

            try {
                const { error } = await db.from('orders').update({
                    discount: 0,
                    discount_reason: null,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].discount = 0;
                    allOrders[idx].discount_reason = null;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
                showToast('Descuento eliminado', 'info');
            } catch (e) {
                console.error('Error removing discount:', e);
                showToast('Error al quitar descuento: ' + e.message, 'error');
            }
        }

        // ==================== STAFF / CADETES ====================
        async function assignStaff(orderId, staffName) {
            try {
                const { error } = await db.from('orders').update({
                    assigned_to: staffName || null,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].assigned_to = staffName || null;
                    allOrders[idx].updated_at = new Date().toISOString();
                }
                renderOrderList();
                if (staffName) showToast(`Cadete asignado: ${staffName}`, 'success');
            } catch (e) {
                console.error('Error assigning staff:', e);
                showToast('Error al asignar cadete: ' + e.message, 'error');
            }
        }

        function openStaffManager() {
            document.getElementById('modal-staff').classList.remove('hidden');
            renderStaffList();
        }

        function closeStaffManager() {
            document.getElementById('modal-staff').classList.add('hidden');
        }

        function renderStaffList() {
            const container = document.getElementById('staff-list');
            const cadetes = staffCache.filter(s => s.role === 'cadete');
            container.innerHTML = cadetes.map(s => `
                <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">üèçÔ∏è</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${s.name}</p>
                            ${s.phone ? `<p class="text-xs text-gray-500">${s.phone}</p>` : ''}
                        </div>
                    </div>
                    <button onclick="removeStaffMember('${s.id}')" class="text-xs text-red-400 hover:text-red-600">Eliminar</button>
                </div>
            `).join('') || '<p class="text-sm text-gray-400 text-center py-4">No hay cadetes</p>';
        }

        async function addStaffMember() {
            const nameInput = document.getElementById('new-staff-name');
            const name = (nameInput.value || '').trim();
            if (!name) { showToast('Ingresa un nombre', 'error'); return; }

            try {
                const { data, error } = await db.from('staff').insert({ name, role: 'cadete' }).select().single();
                if (error) throw error;
                staffCache.push(data);
                nameInput.value = '';
                renderStaffList();
                renderOrderDetail();
                showToast(`Cadete "${name}" agregado`, 'success');
            } catch (e) {
                console.error('Error adding staff:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function removeStaffMember(staffId) {
            try {
                const { error } = await db.from('staff').update({ is_active: false }).eq('id', staffId);
                if (error) throw error;
                staffCache = staffCache.filter(s => s.id !== staffId);
                renderStaffList();
                renderOrderDetail();
                showToast('Cadete eliminado', 'info');
            } catch (e) {
                console.error('Error removing staff:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== ADD ITEM MODAL ====================
        async function loadProducts() {
            if (productsCache.length > 0) return;
            try {
                const { data, error } = await db.from('products').select('id, name, price, category_id, slug').order('name');
                if (error) throw error;
                productsCache = data || [];
            } catch (e) {
                console.error('Error loading products:', e);
                showToast('Error cargando productos: ' + e.message, 'error');
            }
        }

        async function openAddItemModal(orderId) {
            addItemOrderId = orderId;
            document.getElementById('modal-add-item').classList.remove('hidden');
            document.getElementById('product-search-input').value = '';
            document.getElementById('product-search-input').focus();
            await loadProducts();
            renderProductGrid(productsCache);
        }

        function closeAddItemModal() {
            document.getElementById('modal-add-item').classList.add('hidden');
            addItemOrderId = null;
        }

        function filterProducts(query) {
            const q = query.toLowerCase().trim();
            if (!q) {
                renderProductGrid(productsCache);
                return;
            }
            const filtered = productsCache.filter(p => (p.name || '').toLowerCase().includes(q));
            renderProductGrid(filtered);
        }

        let filteredProductsCache = [];
        function renderProductGrid(products) {
            filteredProductsCache = products;
            const container = document.getElementById('product-grid');
            if (products.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-12">No se encontraron productos</div>';
                return;
            }
            container.innerHTML = products.map((p, idx) => `
                <button onclick="addProductByIndex(${idx})"
                        class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-400 hover:shadow-sm transition text-left">
                    <p class="text-sm font-medium text-gray-800 truncate">${p.name}</p>
                    <p class="text-sm font-bold text-orange-600 mt-1">${fmt(p.price)}</p>
                </button>
            `).join('');
        }

        function addProductByIndex(idx) {
            const product = filteredProductsCache[idx];
            if (product && addItemOrderId) addItemToOrder(addItemOrderId, product);
        }

        async function addItemToOrder(orderId, product) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const newItem = {
                name: product.name,
                price: product.price || 0,
                quantity: 1,
                subtotal: product.price || 0,
                slug: product.slug || '',
                product_id: product.id || null
            };

            const items = [...(order.items || []), newItem];
            closeAddItemModal();
            await updateOrderInDB(orderId, items);
            showToast('Agregado: ' + product.name, 'success');
        }

        // ==================== CANCEL ORDER ====================
        async function cancelOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            if (!confirm('Cancelar pedido #' + (order.order_number || '') + '?\n\nEsta accion no se puede deshacer.')) return;

            try {
                const { error } = await db.from('orders').update({
                    status: 'cancelled',
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'cancelled';
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                showToast('Pedido #' + order.order_number + ' cancelado', 'error');
                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error cancelling order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== STATS ====================
        function updateStats() {
            const todayOrders = allOrders.filter(o => o.status !== 'cancelled');
            const revenue = todayOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
            const count = todayOrders.length;
            const avg = count > 0 ? Math.round(revenue / count) : 0;

            document.getElementById('stat-revenue').textContent = fmt(revenue);
            document.getElementById('stat-count').textContent = count;
            document.getElementById('stat-avg').textContent = fmt(avg);

            // Late orders badge - only delivery orders > 40min since confirmed
            const lateOrders = allOrders.filter(o => {
                if (o.delivery_type !== 'delivery') return false;
                if (!['confirmed', 'preparing', 'ready', 'delivering'].includes(o.status)) return false;
                const ref = o.confirmed_at || o.created_at;
                const minutes = Math.floor((Date.now() - new Date(ref)) / 60000);
                return minutes >= 40;
            });

            const badge = document.getElementById('late-badge');
            if (lateOrders.length > 0) {
                badge.textContent = 'üî¥ ' + lateOrders.length + ' demorado' + (lateOrders.length > 1 ? 's' : '');
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==================== ORDER STATUS UPDATES ====================
        async function confirmOrder(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'confirmed',
                    confirmed_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido confirmado', 'success');

                // Auto-print on confirm
                printOrder(orderId);

                // Notificar cliente por WhatsApp
                notifyCustomerWhatsApp(orderId, 'confirmed');

                // Update local state immediately
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'confirmed';
                    allOrders[idx].confirmed_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error confirming order:', e);
                showToast('Error al confirmar: ' + e.message, 'error');
            }
        }

        async function markReady(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'ready',
                    ready_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido listo', 'success');

                // Notificar cliente por WhatsApp
                notifyCustomerWhatsApp(orderId, 'ready');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'ready';
                    allOrders[idx].ready_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function markDelivering(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'delivering',
                    delivering_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido enviado', 'success');

                // Notificar cliente por WhatsApp
                notifyCustomerWhatsApp(orderId, 'delivering');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'delivering';
                    allOrders[idx].delivering_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function markDelivered(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'delivered',
                    delivered_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido entregado', 'success');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'delivered';
                    allOrders[idx].delivered_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== EXECUTE MAIN ACTION (for Enter key) ====================
        function executeMainAction() {
            if (!selectedOrderId) return;
            const order = allOrders.find(o => o.id === selectedOrderId);
            if (!order) return;
            const isDelivery = order.delivery_type === 'delivery';
            if (order.status === 'pending') confirmOrder(order.id);
            else if ((order.status === 'confirmed' || order.status === 'preparing') && isDelivery) markReady(order.id);
            else if ((order.status === 'confirmed' || order.status === 'preparing') && !isDelivery) markDelivered(order.id);
            else if (order.status === 'ready' && isDelivery) markDelivering(order.id);
            else if (order.status === 'delivering') markDelivered(order.id);
        }

        // ==================== QZ TRAY ====================
        async function connectQZHost(host) {
            try {
                if (typeof qz === 'undefined') { updateQZStatus(false, 'No cargado'); return false; }
                if (qz.websocket.isActive()) await qz.websocket.disconnect();
                qz.security.setCertificatePromise(function(resolve) { resolve(); });
                qz.security.setSignaturePromise(function() { return function(resolve) { resolve(); }; });

                try {
                    await qz.websocket.connect({ host: host });
                    console.log('QZ Tray conectado a', host);
                    return true;
                } catch (e1) {
                    console.warn('QZ Tray: fallo IP ' + host + ', intentando localhost...');
                    try {
                        if (qz.websocket.isActive()) await qz.websocket.disconnect();
                        await qz.websocket.connect();
                        console.log('QZ Tray conectado via localhost (fallback para ' + host + ')');
                        return true;
                    } catch (e2) {
                        console.warn('QZ Tray no disponible en ' + host + ' ni localhost:', e2.message);
                        return false;
                    }
                }
            } catch (e) {
                console.warn('QZ Tray error general:', e.message);
                return false;
            }
        }

        async function disconnectQZ() {
            try { if (typeof qz !== 'undefined' && qz.websocket.isActive()) await qz.websocket.disconnect(); } catch (e) {}
        }

        async function checkQZStatus() {
            if (typeof qz === 'undefined') { updateQZStatus(false, 'No cargado'); return; }

            let localOk = false;
            try {
                if (qz.websocket.isActive()) await qz.websocket.disconnect();
                qz.security.setCertificatePromise(function(resolve) { resolve(); });
                qz.security.setSignaturePromise(function() { return function(resolve) { resolve(); }; });
                await qz.websocket.connect();
                localOk = true;
                const localPrinters = await qz.printers.find();
                await qz.websocket.disconnect();
                const hasBarra = localPrinters.includes(PRINTERS.BARRA);
                const hasMinuta = localPrinters.includes(PRINTERS.MINUTA);
                const hasParrilla = localPrinters.includes(PRINTERS.PARRILLA);

                let label = 'Conectado';
                if (hasBarra && (hasMinuta || hasParrilla)) label = 'Barra + Cocina';
                else if (hasBarra) label = 'Barra (local)';
                else if (hasMinuta || hasParrilla) label = 'Cocina (local)';

                updateQZStatus(true, label);
                qzConnected = true;
            } catch (e) {
                updateQZStatus(false, 'Desconectado');
                qzConnected = false;
            }
        }

        // connectQZ in initApp just calls checkQZStatus
        async function connectQZ() {
            await checkQZStatus();
        }

        function updateQZStatus(connected, label) {
            const dot = document.getElementById('qz-dot');
            const lbl = document.getElementById('qz-label');
            dot.className = 'w-2.5 h-2.5 rounded-full ' + (connected ? 'bg-green-500' : 'bg-red-500');
            lbl.textContent = label || 'QZ Tray';
        }

        // Check QZ status every 30s
        setInterval(async () => {
            if (appInitialized) await checkQZStatus();
        }, 30000);

        function getPrinterForCategory(cat) {
            return CATEGORY_PRINTER_MAP[(cat || '').toLowerCase().trim()] || PRINTERS.BARRA;
        }

        function inferCategoryFromName(name) {
            if (!name) return 'minutas';
            const n = name.toLowerCase();
            if (n.includes('empanada') || n.includes('emp ') || n.includes('emp.')) return 'empanadas';
            if (n.includes('pizza')) return 'pizzas';
            if (n.includes('lomito') || n.includes('milanesa') || n.includes('hamburguesa') || n.includes('suprema')) return 'minutas';
            if (n.includes('flan') || n.includes('helado') || n.includes('cheese')) return 'postres';
            if (n.includes('sorrentino') || n.includes('tagliatelle') || n.includes('lasagna') || n.includes('noqui') || n.includes('raviole')) return 'pastas';
            if (n.includes('bife') || n.includes('asado') || n.includes('bondiola') || n.includes('matambre') || n.includes('pollo')) return 'parrilla';
            if (n.includes('coca') || n.includes('fanta') || n.includes('sprite') || n.includes('agua') || n.includes('cerveza') || n.includes('vino')) return 'bebidas';
            return 'minutas';
        }

        function buildKitchenTicketData(items, orderNumber, deliveryInfo) {
            const data = [
                '\x1B\x40', '\x1B\x61\x01', '\x1B\x21\x30',
                `PEDIDO #${orderNumber}\n`,
                '\x1B\x21\x00', `${deliveryInfo}\n`,
                '\x1B\x61\x00', '--------------------------------\n'
            ];
            for (const item of items) {
                data.push('\x1B\x21\x10', `${item.quantity}x ${item.name}\n`, '\x1B\x21\x00');
                if (item.obs) data.push(`   -> ${item.obs}\n`);
                if (item.cooking_method) {
                    const cm = item.cooking_method === 'frito' ? 'Frita' : item.cooking_method === 'horno' ? 'Al Horno' : item.cooking_method;
                    data.push(`   [${cm}]\n`);
                }
            }
            data.push('--------------------------------\n', `${new Date().toLocaleTimeString('es-AR')}\n`, '\n\n\n', '\x1D\x56\x00');
            return data;
        }

        function buildFullTicketData(order) {
            const deliveryInfo = order.delivery_type === 'pickup' ? 'RETIRA EN LOCAL' : `DELIVERY - ${order.delivery_address || ''}`;
            const payLabel = order.payment_method === 'mercadopago' ? 'Mercado Pago' : order.payment_method === 'cash' || order.payment_method === 'efectivo' ? 'Efectivo' : order.payment_method === 'transfer' ? 'Transferencia' : (order.payment_method || '');
            const data = [
                '\x1B\x40', '\x1B\x61\x01', '\x1B\x21\x30', '7TRES7\n',
                '\x1B\x21\x00', 'Restaurant & Delivery\n', 'Calle 18 N 737 - Gral. Pico\n', 'Tel: 2302 51-5656\n',
                '================================\n', '\x1B\x61\x00',
                `Pedido: #${order.order_number}\n`, `${deliveryInfo}\n`,
                `Fecha: ${new Date(order.created_at).toLocaleString('es-AR')}\n`, '--------------------------------\n'
            ];
            for (const item of (order.items || [])) {
                const nameStr = (`${item.quantity}x ${item.name}`).substring(0, 24).padEnd(24);
                const priceStr = ('$' + ((item.subtotal || item.price * item.quantity) || 0).toLocaleString('es-AR')).padStart(8);
                data.push(`${nameStr}${priceStr}\n`);
            }
            data.push('--------------------------------\n');
            const subtotal = parseFloat(order.subtotal || order.total || 0);
            data.push(`${'Subtotal:'.padEnd(24)}$${subtotal.toLocaleString('es-AR').padStart(8)}\n`);
            if (parseFloat(order.discount || 0) > 0) data.push(`${'Descuento:'.padEnd(24)}-$${parseFloat(order.discount).toLocaleString('es-AR').padStart(7)}\n`);
            if (parseFloat(order.delivery_fee || 0) > 0) data.push(`${'Envio:'.padEnd(24)}$${parseFloat(order.delivery_fee).toLocaleString('es-AR').padStart(8)}\n`);
            data.push('================================\n', '\x1B\x21\x10');
            data.push(`${'TOTAL:'.padEnd(24)}$${parseFloat(order.total).toLocaleString('es-AR').padStart(8)}\n`);
            data.push('\x1B\x21\x00', `Pago: ${payLabel}\n`, '================================\n');
            data.push('\x1B\x61\x01', 'Gracias por tu compra!\n', 'Instagram: @737resto\n', '\n\n\n', '\x1D\x56\x00');
            return data;
        }

        async function printOrder(orderId) {
            try {
                let order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    const { data, error } = await db.from('orders').select('*').eq('id', orderId).single();
                    if (error || !data) { showToast('Error obteniendo pedido', 'error'); return; }
                    order = data;
                }
                if (typeof qz === 'undefined') { showToast('QZ Tray no cargado', 'error'); return; }

                const deliveryInfo = order.delivery_type === 'pickup' ? 'RETIRA EN LOCAL' : `DELIVERY - ${order.delivery_address || ''}`;

                // Agrupar items por impresora
                const itemsByPrinter = {};
                for (const item of (order.items || [])) {
                    const cat = item.category || inferCategoryFromName(item.name);
                    const printer = getPrinterForCategory(cat);
                    if (!itemsByPrinter[printer]) itemsByPrinter[printer] = [];
                    itemsByPrinter[printer].push(item);
                }

                // Construir todos los print jobs
                const allJobs = [];
                for (const [printer, items] of Object.entries(itemsByPrinter)) {
                    if (printer !== PRINTERS.BARRA) {
                        allJobs.push({ printer, data: buildKitchenTicketData(items, order.order_number, deliveryInfo) });
                    }
                }
                allJobs.push({ printer: PRINTERS.BARRA, data: buildFullTicketData(order) });

                if (qz.websocket.isActive()) await qz.websocket.disconnect();
                qz.security.setCertificatePromise(function(resolve) { resolve(); });
                qz.security.setSignaturePromise(function() { return function(resolve) { resolve(); }; });
                await qz.websocket.connect();

                let printed = 0;
                for (const job of allJobs) {
                    try {
                        const config = qz.configs.create(job.printer);
                        await qz.print(config, job.data);
                        printed++;
                    } catch (printErr) {
                        console.warn('No se pudo imprimir en ' + job.printer + ':', printErr.message);
                    }
                }

                await disconnectQZ();

                if (printed > 0) showToast(`Pedido #${order.order_number}: ${printed} ticket(s) impresos`, 'success');
                else showToast('No se pudo imprimir en ninguna impresora', 'error');

            } catch (e) {
                console.error('Error imprimiendo:', e);
                showToast('Error al imprimir: ' + e.message, 'error');
                await disconnectQZ();
            }
        }

        // ==================== PAGO ====================
        async function updatePaymentMethod(orderId, method) {
            try {
                await db.from('orders').update({ payment_method: method, updated_at: new Date().toISOString() }).eq('id', orderId);
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) allOrders[idx].payment_method = method;
                updateStats();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        // ==================== CIERRE DE CAJA ====================
        async function openCierreCaja() {
            document.getElementById('modal-cierre').classList.remove('hidden');
            renderCierre();
        }

        function closeCierreCaja() {
            document.getElementById('modal-cierre').classList.add('hidden');
        }

        function getCierreOrders() {
            const turno = document.getElementById('cierre-turno').value;
            let orders = allOrders.filter(o => o.status !== 'cancelled');

            if (turno === 'noon') {
                orders = orders.filter(o => {
                    const h = new Date(o.created_at).getHours();
                    return h >= 11 && h < 16;
                });
            } else if (turno === 'night') {
                orders = orders.filter(o => {
                    const h = new Date(o.created_at).getHours();
                    return h >= 18 || h < 2;
                });
            }
            return orders;
        }

        function renderCierre() {
            const orders = getCierreOrders();
            const delivered = orders.filter(o => o.status === 'delivered');
            const active = orders.filter(o => o.status !== 'delivered');

            // Cancelled orders (separate from getCierreOrders which excludes them)
            const turno = document.getElementById('cierre-turno').value;
            let cancelledOrders = allOrders.filter(o => o.status === 'cancelled');
            if (turno === 'noon') {
                cancelledOrders = cancelledOrders.filter(o => { const h = new Date(o.created_at).getHours(); return h >= 11 && h < 16; });
            } else if (turno === 'night') {
                cancelledOrders = cancelledOrders.filter(o => { const h = new Date(o.created_at).getHours(); return h >= 18 || h < 2; });
            }
            const cancelledTotal = cancelledOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

            const totalVentas = orders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
            const totalDeliveryFees = orders.reduce((s, o) => s + parseFloat(o.delivery_fee || 0), 0);
            const totalDiscounts = orders.reduce((s, o) => s + parseFloat(o.discount || 0), 0);
            const count = orders.length;
            const avg = count > 0 ? Math.round(totalVentas / count) : 0;

            // By delivery type
            const deliveryOrders = orders.filter(o => o.delivery_type === 'delivery');
            const pickupOrders = orders.filter(o => o.delivery_type === 'pickup');
            const deliveryTotal = deliveryOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
            const pickupTotal = pickupOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

            // By payment method
            const byPayment = {};
            for (const o of orders) {
                const m = o.payment_method || 'cash';
                if (!byPayment[m]) byPayment[m] = { count: 0, total: 0 };
                byPayment[m].count++;
                byPayment[m].total += parseFloat(o.total || 0);
            }

            // Top products
            const productCount = {};
            for (const o of orders) {
                for (const item of (o.items || [])) {
                    const name = item.name || 'Desconocido';
                    if (!productCount[name]) productCount[name] = 0;
                    productCount[name] += item.quantity || 1;
                }
            }
            const topProducts = Object.entries(productCount).sort((a, b) => b[1] - a[1]).slice(0, 8);

            const turnoLabel = document.getElementById('cierre-turno').selectedOptions[0].text;
            const fecha = new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            document.getElementById('cierre-content').innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm">${fecha} - ${turnoLabel}</p>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                        <p class="text-green-600 text-sm font-medium">Total Ventas</p>
                        <p class="text-2xl font-bold text-green-700">${fmt(totalVentas)}</p>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                        <p class="text-orange-600 text-sm font-medium">Pedidos</p>
                        <p class="text-2xl font-bold text-orange-700">${count}</p>
                        <p class="text-xs text-gray-400">${delivered.length} entregados / ${active.length} en curso</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                        <p class="text-blue-600 text-sm font-medium">Ticket Promedio</p>
                        <p class="text-2xl font-bold text-blue-700">${fmt(avg)}</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center">
                        <p class="text-purple-600 text-sm font-medium">Envios cobrados</p>
                        <p class="text-2xl font-bold text-purple-700">${fmt(totalDeliveryFees)}</p>
                        ${totalDiscounts > 0 ? `<p class="text-xs text-red-500">Desc: -${fmt(totalDiscounts)}</p>` : ''}
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                        <p class="text-red-600 text-sm font-medium">Cancelados</p>
                        <p class="text-2xl font-bold text-red-700">${cancelledOrders.length}</p>
                        <p class="text-xs text-gray-400">${fmt(cancelledTotal)} perdido</p>
                    </div>
                </div>

                <!-- Two columns -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- By delivery type -->
                    <div class="bg-gray-50 rounded-xl p-5">
                        <h3 class="font-bold text-gray-700 mb-4">Por Tipo de Pedido</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between bg-white rounded-lg p-3 border">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">üöö</span>
                                    <div>
                                        <p class="font-semibold">Delivery</p>
                                        <p class="text-xs text-gray-400">${deliveryOrders.length} pedidos</p>
                                    </div>
                                </div>
                                <span class="font-bold text-lg">${fmt(deliveryTotal)}</span>
                            </div>
                            <div class="flex items-center justify-between bg-white rounded-lg p-3 border">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">üè™</span>
                                    <div>
                                        <p class="font-semibold">Mostrador / Retira</p>
                                        <p class="text-xs text-gray-400">${pickupOrders.length} pedidos</p>
                                    </div>
                                </div>
                                <span class="font-bold text-lg">${fmt(pickupTotal)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- By payment method -->
                    <div class="bg-gray-50 rounded-xl p-5">
                        <h3 class="font-bold text-gray-700 mb-4">Por Medio de Pago</h3>
                        <div class="space-y-2">
                            ${Object.entries(byPayment).sort((a, b) => b[1].total - a[1].total).map(([method, data]) => `
                                <div class="flex items-center justify-between bg-white rounded-lg p-3 border">
                                    <div class="flex items-center space-x-2">
                                        <span>${PAY_ICONS[method] || 'üí∞'}</span>
                                        <div>
                                            <p class="font-medium text-sm">${PAY_LABELS[method] || method}</p>
                                            <p class="text-xs text-gray-400">${data.count} pedido${data.count > 1 ? 's' : ''}</p>
                                        </div>
                                    </div>
                                    <span class="font-bold">${fmt(data.total)}</span>
                                </div>
                            `).join('')}
                            ${Object.keys(byPayment).length === 0 ? '<p class="text-gray-400 text-sm text-center py-4">Sin pedidos</p>' : ''}
                        </div>
                    </div>
                </div>

                <!-- Top Products -->
                ${topProducts.length > 0 ? `
                <div class="bg-gray-50 rounded-xl p-5">
                    <h3 class="font-bold text-gray-700 mb-4">Productos mas vendidos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        ${topProducts.map(([name, qty], i) => `
                            <div class="bg-white rounded-lg p-3 border text-center">
                                <p class="font-bold text-orange-600">${qty}</p>
                                <p class="text-xs text-gray-600 truncate" title="${name}">${name}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
            `;
        }

        async function printCierreCaja() {
            try {
                if (typeof qz === 'undefined') { showToast('QZ Tray no disponible', 'error'); return; }
                if (qz.websocket.isActive()) await qz.websocket.disconnect();
                qz.security.setCertificatePromise(function(resolve) { resolve(); });
                qz.security.setSignaturePromise(function() { return function(resolve) { resolve(); }; });
                await qz.websocket.connect();

                const orders = getCierreOrders();
                const totalVentas = orders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
                const totalDeliveryFees = orders.reduce((s, o) => s + parseFloat(o.delivery_fee || 0), 0);
                const totalDiscounts = orders.reduce((s, o) => s + parseFloat(o.discount || 0), 0);
                const deliveryOrders = orders.filter(o => o.delivery_type === 'delivery');
                const pickupOrders = orders.filter(o => o.delivery_type === 'pickup');
                const deliveryTotal = deliveryOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
                const pickupTotal = pickupOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

                // Cancelled
                const cancelledOrders = allOrders.filter(o => o.status === 'cancelled');
                const cancelledTotal = cancelledOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

                const byPayment = {};
                for (const o of orders) {
                    const m = o.payment_method || 'cash';
                    if (!byPayment[m]) byPayment[m] = { count: 0, total: 0 };
                    byPayment[m].count++;
                    byPayment[m].total += parseFloat(o.total || 0);
                }

                const turnoLabel = document.getElementById('cierre-turno').selectedOptions[0].text;
                const fecha = new Date().toLocaleDateString('es-AR');
                const hora = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

                const data = [
                    '\x1B\x40', '\x1B\x61\x01', '\x1B\x21\x30',
                    'CIERRE DE CAJA\n',
                    '\x1B\x21\x00',
                    '7TRES7 Restaurant\n',
                    `${fecha} - ${turnoLabel}\n`,
                    `Impreso: ${hora}\n`,
                    '================================\n',
                    '\x1B\x61\x00',
                    '\x1B\x21\x10',
                    `${'TOTAL VENTAS:'.padEnd(20)}${fmt(totalVentas).padStart(12)}\n`,
                    '\x1B\x21\x00',
                    `${'Pedidos:'.padEnd(20)}${String(orders.length).padStart(12)}\n`,
                    `${'Ticket promedio:'.padEnd(20)}${fmt(orders.length > 0 ? Math.round(totalVentas / orders.length) : 0).padStart(12)}\n`,
                    '--------------------------------\n',
                    'POR TIPO DE PEDIDO:\n',
                    `${'  Delivery:'.padEnd(20)}${fmt(deliveryTotal).padStart(12)}\n`,
                    `${'    (pedidos)'.padEnd(20)}${String(deliveryOrders.length).padStart(12)}\n`,
                    `${'  Mostrador:'.padEnd(20)}${fmt(pickupTotal).padStart(12)}\n`,
                    `${'    (pedidos)'.padEnd(20)}${String(pickupOrders.length).padStart(12)}\n`,
                    '--------------------------------\n',
                    'POR MEDIO DE PAGO:\n'
                ];

                for (const [method, d] of Object.entries(byPayment).sort((a, b) => b[1].total - a[1].total)) {
                    const label = '  ' + (PAY_LABELS[method] || method) + ':';
                    data.push(`${label.padEnd(20)}${fmt(d.total).padStart(12)}\n`);
                    data.push(`${'    (pedidos)'.padEnd(20)}${String(d.count).padStart(12)}\n`);
                }

                data.push('--------------------------------\n');
                if (totalDeliveryFees > 0) data.push(`${'Envios cobrados:'.padEnd(20)}${fmt(totalDeliveryFees).padStart(12)}\n`);
                if (totalDiscounts > 0) data.push(`${'Descuentos:'.padEnd(20)}${('-' + fmt(totalDiscounts)).padStart(12)}\n`);
                if (cancelledOrders.length > 0) {
                    data.push(`${'Cancelados:'.padEnd(20)}${String(cancelledOrders.length).padStart(12)}\n`);
                    data.push(`${'  Total cancelado:'.padEnd(20)}${fmt(cancelledTotal).padStart(12)}\n`);
                }
                data.push('================================\n');
                data.push('\x1B\x61\x01', 'Cierre generado por 7Tres7 Caja\n');
                data.push('\n\n\n', '\x1D\x56\x00');

                const config = qz.configs.create(PRINTERS.BARRA);
                await qz.print(config, data);
                await disconnectQZ();
                showToast('Cierre impreso', 'success');
            } catch (e) {
                console.error('Error imprimiendo cierre:', e);
                showToast('Error: ' + e.message, 'error');
                await disconnectQZ();
            }
        }

        // ==================== QZ TRAY DIAGNOSTICO ====================
        async function diagnosticQZ() {
            if (typeof qz === 'undefined') {
                alert('QZ Tray: libreria no cargada.\n\nVerifica que la PC tenga internet para cargar qz-tray.min.js');
                return;
            }

            let report = '=== DIAGNOSTICO QZ TRAY ===\n\n';
            const hosts = [
                { name: 'PC BARRA', ip: QZ_HOSTS.BARRA, printers: ['Barra'] },
                { name: 'PC COCINA', ip: QZ_HOSTS.COCINA, printers: ['Minuta', 'Parrilla Delivery'] }
            ];

            for (const host of hosts) {
                report += `${host.name} (${host.ip}):\n`;
                try {
                    if (qz.websocket.isActive()) await qz.websocket.disconnect();
                    qz.security.setCertificatePromise(function(resolve) { resolve(); });
                    qz.security.setSignaturePromise(function() { return function(resolve) { resolve(); }; });
                    await qz.websocket.connect({ host: host.ip });
                    report += `  Conexion: OK\n`;

                    const found = await qz.printers.find();
                    report += `  Impresoras encontradas: ${found.length}\n`;
                    for (const p of found) {
                        const expected = host.printers.includes(p) ? ' [CONFIGURADA]' : '';
                        report += `    - ${p}${expected}\n`;
                    }

                    for (const expected of host.printers) {
                        if (!found.includes(expected)) {
                            report += `  !! FALTA: "${expected}" no encontrada en esta PC\n`;
                        }
                    }

                    await qz.websocket.disconnect();
                } catch (e) {
                    report += `  Conexion: ERROR - ${e.message}\n`;
                    report += `  Verificar:\n`;
                    report += `    - QZ Tray esta corriendo en esa PC?\n`;
                    report += `    - Esta PC esta en la misma red WiFi?\n`;
                    report += `    - IP ${host.ip} es correcta?\n`;
                }
                report += '\n';
            }

            report += 'Desde esta PC: ' + window.location.hostname + '\n';
            report += 'Hora: ' + new Date().toLocaleString('es-AR');

            console.log(report);
            alert(report);
        }

        // ==================== NOTIFICACION WHATSAPP ====================
        async function notifyCustomerWhatsApp(orderId, event) {
            try {
                let order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    const { data } = await db.from('orders').select('*, customers(name, phone)').eq('id', orderId).single();
                    order = data;
                }
                if (!order) return;
                const phone = order.customers?.phone || (order.customer_notes?.match(/Tel: ([^|]+)/)?.[1]?.trim());
                if (!phone) return;
                const cleanPhone = phone.replace(/\D/g, '');
                const name = order.customers?.name || (order.customer_notes?.match(/Nombre: ([^|]+)/)?.[1]?.trim()) || '';
                const deliveryLabel = order.delivery_type === 'pickup' ? 'retiro en local' : 'delivery';

                let msg = '';
                if (event === 'confirmed') {
                    msg = `Hola ${name}! Tu pedido #${order.order_number} fue *confirmado* y ya estamos preparandolo. Tipo: ${deliveryLabel}. Total: $${parseFloat(order.total).toLocaleString('es-AR')}. Gracias por elegir 7Tres7!`;
                } else if (event === 'ready') {
                    msg = order.delivery_type === 'pickup'
                        ? `Hola ${name}! Tu pedido #${order.order_number} esta *listo para retirar*. Te esperamos en Calle 18 N 737. Gracias!`
                        : `Hola ${name}! Tu pedido #${order.order_number} esta *listo* y sale en un ratito. Gracias por elegir 7Tres7!`;
                } else if (event === 'delivering') {
                    msg = `Hola ${name}! Tu pedido #${order.order_number} ya *salio en camino*! Llegamos en breve. Gracias por elegir 7Tres7!`;
                }

                if (msg) window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            } catch (e) { console.warn('Error notificando:', e); }
        }

        // ==================== HELPERS ====================
        function extractFromNotes(notes, field) {
            if (!notes) return '';
            const match = notes.match(new RegExp(field + ':\\s*([^|]+)'));
            return match ? match[1].trim() : '';
        }

        function showToast(msg, type = 'info') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg text-sm`;
            toast.textContent = msg;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== TIMER UPDATE ====================
        setInterval(() => {
            if (!appInitialized) return;
            // Update all visible timers using order data
            document.querySelectorAll('[data-order-id]').forEach(el => {
                const order = allOrders.find(o => o.id === el.dataset.orderId);
                if (!order) return;
                const ti = getTimeInfo(order);
                el.textContent = ti.label;
                el.className = `text-xs font-medium px-2 py-0.5 rounded-full ${ti.bg} ${ti.color} w-14 text-center ${ti.pulse ? 'timer-pulse' : ''}`;
            });
            // Update late badge & stats
            updateStats();
            // Update detail panel time if showing an active order
            if (selectedOrderId) {
                const order = allOrders.find(o => o.id === selectedOrderId);
                if (order && ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status)) {
                    renderOrderDetail();
                }
            }
        }, 30000);

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.key === 'F2') {
                e.preventDefault();
                document.getElementById('search-input')?.focus();
            }
            if (e.key === 'F12') {
                e.preventDefault();
                openCierreCaja();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                selectedOrderId = null;
                deletingItemIndex = null;
                renderOrderDetail();
                renderOrderList();
                closeCierreCaja();
                closeAddItemModal();
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectNextOrder();
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectPrevOrder();
            }
            if (e.key === 'Enter' && selectedOrderId) {
                e.preventDefault();
                executeMainAction();
            }
            if (e.key >= '1' && e.key <= '6' && e.altKey) {
                e.preventDefault();
                const tabs = ['active', 'pending', 'preparing', 'ready', 'delivered', 'cancelled'];
                const idx = parseInt(e.key) - 1;
                if (idx < tabs.length) switchTab(tabs[idx]);
            }
        });
    </script>
</body>
</html>
