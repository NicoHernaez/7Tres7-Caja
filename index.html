<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7Tres7 - Panel de Caja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Impresion manejada por Supabase Trigger + Electron App -->
    <link rel="icon" href="Empanada-avatar.png">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #f1f5f9; }

        /* Glass */
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.06); }
        .glass-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; }

        /* Toast */
        .toast { animation: slideIn 0.3s ease; backdrop-filter: blur(8px); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Order cards */
        .order-row { transition: all 0.15s ease; }
        .order-row:hover { background: rgba(255,255,255,0.04); }
        .order-row.selected { background: rgba(59,130,246,0.1); border-left-color: #3b82f6 !important; }
        .order-row.late { animation: latePulse 2s infinite; }
        @keyframes latePulse { 0%, 100% { background: rgba(255,255,255,0.02); } 50% { background: rgba(239,68,68,0.08); } }

        /* Status badges with glow */
        .status-badge-pending { background: rgba(245,158,11,0.15); color: #fbbf24; box-shadow: 0 0 8px rgba(245,158,11,0.2); }
        .status-badge-confirmed { background: rgba(59,130,246,0.15); color: #60a5fa; box-shadow: 0 0 8px rgba(59,130,246,0.2); }
        .status-badge-preparing { background: rgba(249,115,22,0.15); color: #fb923c; box-shadow: 0 0 8px rgba(249,115,22,0.2); }
        .status-badge-ready { background: rgba(34,197,94,0.15); color: #4ade80; box-shadow: 0 0 8px rgba(34,197,94,0.2); }
        .status-badge-delivering { background: rgba(59,130,246,0.15); color: #60a5fa; box-shadow: 0 0 8px rgba(59,130,246,0.2); }
        .status-badge-delivered { background: rgba(100,116,139,0.15); color: #94a3b8; }
        .status-badge-cancelled { background: rgba(239,68,68,0.15); color: #f87171; box-shadow: 0 0 8px rgba(239,68,68,0.2); }

        /* Status strip gradients */
        .status-strip { width: 4px; border-radius: 2px; flex-shrink: 0; }
        .strip-pending { background: linear-gradient(180deg, #f59e0b, #eab308); }
        .strip-confirmed, .strip-preparing { background: linear-gradient(180deg, #f97316, #ea580c); }
        .strip-ready { background: linear-gradient(180deg, #22c55e, #16a34a); }
        .strip-delivering { background: linear-gradient(180deg, #3b82f6, #6366f1); }
        .strip-delivered { background: linear-gradient(180deg, #64748b, #475569); }
        .strip-cancelled { background: linear-gradient(180deg, #ef4444, #dc2626); }

        /* Glow buttons */
        .btn-glow-green { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 0 15px rgba(34,197,94,0.3); transition: all 0.2s; }
        .btn-glow-green:hover { box-shadow: 0 0 25px rgba(34,197,94,0.5); filter: brightness(1.1); }
        .btn-glow-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 0 15px rgba(59,130,246,0.3); transition: all 0.2s; }
        .btn-glow-blue:hover { box-shadow: 0 0 25px rgba(59,130,246,0.5); filter: brightness(1.1); }
        .btn-glow-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 0 15px rgba(139,92,246,0.3); transition: all 0.2s; }
        .btn-glow-purple:hover { box-shadow: 0 0 25px rgba(139,92,246,0.5); filter: brightness(1.1); }
        .btn-glow-orange { background: linear-gradient(135deg, #f97316, #ea580c); color: white; box-shadow: 0 0 15px rgba(249,115,22,0.3); transition: all 0.2s; }
        .btn-glow-orange:hover { box-shadow: 0 0 25px rgba(249,115,22,0.5); filter: brightness(1.1); }
        .btn-glow-urgent { background: linear-gradient(135deg, #ef4444, #f97316); color: white; box-shadow: 0 0 15px rgba(239,68,68,0.4); transition: all 0.2s; animation: urgentPulse 1.5s ease-in-out infinite; }
        .btn-glow-urgent:hover { box-shadow: 0 0 25px rgba(239,68,68,0.6); filter: brightness(1.1); }
        @keyframes urgentPulse { 0%, 100% { box-shadow: 0 0 15px rgba(239,68,68,0.4); transform: scale(1); } 50% { box-shadow: 0 0 25px rgba(249,115,22,0.6); transform: scale(1.03); } }

        /* Detail panel animation */
        .detail-enter { animation: slideInRight 0.2s ease; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(8px); } to { opacity: 1; transform: translateX(0); } }

        /* Scrollbar dark */
        .order-list-scroll::-webkit-scrollbar, .detail-scroll::-webkit-scrollbar { width: 6px; }
        .order-list-scroll::-webkit-scrollbar-track, .detail-scroll::-webkit-scrollbar-track { background: transparent; }
        .order-list-scroll::-webkit-scrollbar-thumb, .detail-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .order-list-scroll::-webkit-scrollbar-thumb:hover, .detail-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Mother tab active */
        .mother-tab { position: relative; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .mother-tab.active { color: white !important; border-bottom-color: transparent !important; }
        .mother-tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #f97316, #ef4444); border-radius: 1px; }

        /* Timer pulse */
        .timer-pulse { animation: pulse 1.5s infinite; }

        /* Group separator */
        .group-separator { display: flex; align-items: center; gap: 8px; padding: 8px 12px; color: #64748b; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .group-separator::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.06); }

        /* Dark input */
        .dark-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; }
        .dark-input:focus { outline: none; ring: 2px; border-color: #f97316; box-shadow: 0 0 0 2px rgba(249,115,22,0.3); }
        .dark-input::placeholder { color: #64748b; }
    </style>
</head>
<body class="bg-[#0a0a0f]">
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center" style="background: radial-gradient(ellipse at center, #1a1035 0%, #0a0a0f 70%);">
        <div class="glass-card p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <img src="Empanada-avatar.png" alt="7Tres7" class="w-24 h-24 mx-auto rounded-2xl object-cover shadow-lg" style="border: 2px solid rgba(249,115,22,0.4);">
                <h1 class="text-3xl font-bold mt-4 text-white">7TRES7 <span class="text-orange-400">CAJA</span></h1>
                <p class="text-gray-400">Panel de pedidos y caja</p>
            </div>
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center space-x-3 bg-white/5 border border-white/10 text-white py-3 rounded-lg font-semibold hover:bg-white/10 transition">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    <span>Iniciar sesion con Google</span>
                </button>

                <div class="relative my-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 text-gray-500" style="background: rgba(255,255,255,0.05);">o</span></div>
                </div>

                <div id="magic-link-form">
                    <div class="flex space-x-2">
                        <input type="email" id="magic-email" class="flex-1 bg-white/5 border border-white/10 text-white rounded-lg px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="tu@email.com">
                        <button onclick="loginWithMagicLink()" class="btn-glow-orange px-4 py-3 rounded-lg font-semibold whitespace-nowrap">Enviar link</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Te enviamos un link de acceso a tu email</p>
                </div>

                <p id="login-error" class="text-red-400 text-sm text-center hidden"></p>
                <p id="login-success" class="text-green-400 text-sm text-center hidden"></p>
                <p id="login-loading" class="text-gray-400 text-sm text-center hidden pulse">Verificando sesion...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-[#0d1117] text-white px-4 py-2.5 flex items-center justify-between flex-shrink-0 z-20 border-b border-white/5">
            <div class="flex items-center space-x-3">
                <img src="Empanada-avatar.png" alt="7Tres7" class="w-8 h-8 rounded-lg object-cover">
                <h1 class="font-bold text-lg leading-tight">7TRES7 <span class="text-orange-400">CAJA</span></h1>
            </div>
            <div class="flex items-center space-x-4 text-sm">
                <div id="stats-bar" class="hidden md:flex items-center space-x-3 glass rounded-lg px-4 py-1.5">
                    <span>Hoy: <strong id="stat-revenue" class="text-green-400">$0</strong></span>
                    <span class="text-white/10">|</span>
                    <span><strong id="stat-count" class="text-orange-400">0</strong> pedidos</span>
                    <span class="text-white/10">|</span>
                    <span>Prom: <strong id="stat-avg" class="text-blue-400">$0</strong></span>
                    <span id="late-badge" class="hidden bg-red-500/20 text-red-400 text-xs font-bold px-2 py-0.5 rounded-full animate-pulse"></span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="openCierreCaja()" class="btn-glow-purple text-xs font-bold px-3 py-2 rounded-lg" title="F12">CIERRE DE CAJA</button>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 px-3 py-2 rounded-lg hover:bg-white/5 transition text-sm" title="Cerrar sesion">Salir</button>
            </div>
        </header>

        <!-- Mother Tabs (type of service) -->
        <div class="bg-[#0d1117] px-4 py-0 flex items-center justify-between flex-shrink-0 border-b border-white/5">
            <div class="flex items-center space-x-0" id="mother-tab-bar">
                <button class="mother-tab active text-sm font-bold px-5 py-2.5 text-white transition" onclick="switchMotherTab('todos')" data-mtab="todos">Todos</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-500 hover:text-white transition" onclick="switchMotherTab('mostrador')" data-mtab="mostrador">üè™ Mostrador</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-500 hover:text-white transition" onclick="switchMotherTab('delivery')" data-mtab="delivery">üöö Delivery</button>
                <button class="mother-tab text-sm font-bold px-5 py-2.5 text-gray-500 hover:text-white transition" onclick="switchMotherTab('salon')" data-mtab="salon">üçΩÔ∏è Salon</button>
            </div>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <input type="text" id="search-input" class="bg-white/5 border border-white/10 text-white rounded-lg pl-8 pr-3 py-1.5 text-sm w-44 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400 placeholder-gray-500" placeholder="Buscar # o nombre..." oninput="onSearchInput(this.value)" title="F2">
                    <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
        </div>

        <!-- Master-Detail Layout -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Order List (left panel ~58%) -->
            <div class="w-[58%] flex flex-col border-r border-white/5 bg-[#0a0a0f]">
                <div id="order-list" class="flex-1 overflow-y-auto order-list-scroll p-1">
                    <!-- Order rows rendered here -->
                </div>
            </div>

            <!-- Order Detail (right panel ~42%) -->
            <div class="w-[42%] flex flex-col bg-[#0d1117]">
                <div id="order-detail" class="flex-1 overflow-y-auto detail-scroll">
                    <!-- Detail rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tiempo Estimado -->
    <div id="modal-tiempo" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeTimePicker()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-sm mx-auto glass-card shadow-2xl z-10 p-6">
            <h3 class="text-lg font-bold text-white mb-1 text-center">Tiempo estimado</h3>
            <p class="text-sm text-gray-400 mb-4 text-center">Selecciona el tiempo de preparacion</p>
            <div class="grid grid-cols-2 gap-3 mb-4" id="time-options">
                <button onclick="selectTime(25)" class="time-btn py-4 rounded-xl border-2 border-white/10 text-center font-bold text-lg text-white hover:border-green-500 hover:bg-green-500/10 transition">25 min</button>
                <button onclick="selectTime(35)" class="time-btn py-4 rounded-xl border-2 border-white/10 text-center font-bold text-lg text-white hover:border-green-500 hover:bg-green-500/10 transition">35 min</button>
                <button onclick="selectTime(45)" class="time-btn py-4 rounded-xl border-2 border-white/10 text-center font-bold text-lg text-white hover:border-green-500 hover:bg-green-500/10 transition">45 min</button>
                <button onclick="selectTime(55)" class="time-btn py-4 rounded-xl border-2 border-white/10 text-center font-bold text-lg text-white hover:border-green-500 hover:bg-green-500/10 transition">55 min</button>
            </div>
            <button onclick="closeTimePicker()" class="w-full py-2 text-sm text-gray-500 hover:text-gray-300 transition">Cancelar</button>
        </div>
    </div>

    <!-- Modal Enviar Pedido (selector cadete) -->
    <div id="modal-enviar" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeEnviarModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm glass-card shadow-2xl overflow-hidden z-10 p-6">
            <h3 class="text-lg font-bold text-white mb-1">Enviar pedido</h3>
            <p class="text-sm text-gray-400 mb-5">Selecciona el cadete que lleva el pedido</p>
            <div id="enviar-cadetes" class="space-y-2 mb-4"></div>
            <button onclick="closeEnviarModal()" class="w-full py-2 text-sm text-gray-500 hover:text-gray-300 transition">Cancelar</button>
        </div>
    </div>

    <!-- Modal Cierre de Caja -->
    <div id="modal-cierre" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeCierreCaja()"></div>
        <div class="absolute inset-4 md:inset-8 bg-[#111827] border border-white/5 rounded-2xl shadow-2xl overflow-y-auto z-10">
            <div class="sticky top-0 bg-[#0d1117] text-white px-6 py-4 flex items-center justify-between rounded-t-2xl z-10 border-b border-white/5">
                <h2 class="text-xl font-bold">Cierre de Caja</h2>
                <div class="flex items-center space-x-3">
                    <select id="cierre-turno" onchange="renderCierre()" class="bg-white/5 text-white text-sm rounded-lg px-3 py-1.5 border border-white/10">
                        <option value="all">Todo el dia</option>
                        <option value="noon">Mediodia (11-16hs)</option>
                        <option value="night">Noche (18-01hs)</option>
                    </select>
                    <button onclick="printCierreCaja()" class="bg-white/10 text-white text-sm font-bold px-4 py-1.5 rounded-lg hover:bg-white/20 transition">Imprimir</button>
                    <button onclick="closeCierreCaja()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div id="cierre-content" class="p-6"></div>
        </div>
    </div>

    <!-- Modal Staff Manager -->
    <div id="modal-staff" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeStaffManager()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md glass-card shadow-2xl overflow-hidden z-10">
            <div class="bg-[#0d1117] text-white px-5 py-4 flex items-center justify-between border-b border-white/5">
                <h2 class="font-bold text-lg">Administrar cadetes</h2>
                <button onclick="closeStaffManager()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-5 space-y-3">
                <div id="staff-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <div class="flex space-x-2 pt-2 border-t border-white/5">
                    <input type="text" id="new-staff-name" class="flex-1 bg-white/5 border border-white/10 text-white rounded-lg px-3 py-2 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre del cadete" onkeydown="if(event.key==='Enter')addStaffMember()">
                    <button onclick="addStaffMember()" class="btn-glow-blue px-4 py-2 rounded-lg text-sm font-medium">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Add Item -->
    <div id="modal-add-item" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeAddItemModal()"></div>
        <div class="absolute inset-y-8 left-1/2 -translate-x-1/2 w-full max-w-2xl bg-[#111827] border border-white/5 rounded-2xl shadow-2xl overflow-hidden z-10 flex flex-col">
            <div class="bg-[#0d1117] text-white px-5 py-4 flex items-center justify-between flex-shrink-0 border-b border-white/5">
                <h2 class="font-bold text-lg">Agregar producto al pedido</h2>
                <button onclick="closeAddItemModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="px-5 py-3 border-b border-white/5 flex-shrink-0">
                <input type="text" id="product-search-input" class="w-full bg-white/5 border border-white/10 text-white rounded-lg px-4 py-2.5 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Buscar producto..." oninput="filterProducts(this.value)">
            </div>
            <div id="product-grid" class="flex-1 overflow-y-auto p-5 grid grid-cols-2 sm:grid-cols-3 gap-3">
                <!-- Products rendered here -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACION ====================
        const SUPABASE_URL = 'https://yfdustfjfmifvgybwinr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmZHVzdGZqZm1pZnZneWJ3aW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzU3ODQsImV4cCI6MjA4NTgxMTc4NH0.YcLo7YXePi0_okJxtPuYLaMQI2-P4C8UxNzXnLfQoBY';
        const AUTHORIZED_EMAILS = ['nicohernaez22@gmail.com', 'lumimartin24@gmail.com', 'martinludmila300@gmail.com'];

        // Impresion manejada por Supabase trigger + Electron App (ver 7tres7-print-app)

        const PAY_LABELS = {
            'cash': 'Efectivo', 'debit_card': 'Tarj. Debito', 'credit_card': 'Tarj. Credito',
            'mercadopago': 'Mercado Pago', 'qr': 'QR', 'prepaid_card': 'Prepaga', 'transfer': 'Transferencia'
        };
        const PAY_ICONS = {
            'cash': 'üíµ', 'debit_card': 'üí≥', 'credit_card': 'üí≥',
            'mercadopago': 'üì≤', 'qr': 'üì±', 'prepaid_card': 'üí≥', 'transfer': 'üè¶'
        };

        let db = null;
        let currentUser = null;
        let appInitialized = false;
        let allOrders = [];
        let realtimeChannel = null;
        let knownOrderIds = new Set();

        // UI state
        let selectedOrderId = null;
        let motherTab = 'todos';   // 'todos', 'mostrador', 'delivery', 'salon'
        let subTab = 'pending';    // kept for backward compat but unused
        let searchQuery = '';
        let productsCache = [];
        let addItemOrderId = null;
        let deletingItemIndex = null; // Track which item is showing delete reason UI
        let staffCache = []; // cadetes, mozos, etc.

        // ==================== SUPABASE INIT ====================
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== AUTH ====================
        db.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event, session?.user?.email);
            const loading = document.getElementById('login-loading');
            const error = document.getElementById('login-error');

            if (session && !appInitialized) {
                const email = session.user.email;

                if (!AUTHORIZED_EMAILS.includes(email.toLowerCase())) {
                    await db.auth.signOut();
                    loading.classList.add('hidden');
                    error.textContent = 'Acceso denegado. El email ' + email + ' no esta autorizado.';
                    error.classList.remove('hidden');
                    return;
                }

                appInitialized = true;
                currentUser = session.user;
                error.classList.add('hidden');
                loading.classList.add('hidden');

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');

                initApp();
                showToast('Bienvenido a 7Tres7 Caja', 'success');

            } else if (event === 'SIGNED_OUT') {
                appInitialized = false;
                currentUser = null;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                loading.classList.add('hidden');
                if (realtimeChannel) {
                    db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
            }
        });

        // Fallback: hide loading if auth doesn't fire within 3s
        setTimeout(() => {
            if (!appInitialized) {
                document.getElementById('login-loading').classList.add('hidden');
            }
        }, 3000);

        async function loginWithGoogle() {
            const error = document.getElementById('login-error');
            error.classList.add('hidden');
            try {
                const { error: authError } = await db.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://7-tres7-caja.vercel.app'
                    }
                });
                if (authError) throw authError;
            } catch (e) {
                error.textContent = 'Error al iniciar sesion: ' + e.message;
                error.classList.remove('hidden');
            }
        }

        async function loginWithMagicLink() {
            const email = document.getElementById('magic-email').value.trim();
            const error = document.getElementById('login-error');
            const success = document.getElementById('login-success');
            error.classList.add('hidden');
            success.classList.add('hidden');

            if (!email) { error.textContent = 'Ingresa tu email'; error.classList.remove('hidden'); return; }
            if (!AUTHORIZED_EMAILS.includes(email)) { error.textContent = 'El email ' + email + ' no esta autorizado.'; error.classList.remove('hidden'); return; }

            try {
                const { error: authError } = await db.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.href.split('#')[0].split('?')[0]
                    }
                });
                if (authError) throw authError;
                success.textContent = 'Link enviado a ' + email + '. Revisa tu bandeja de entrada.';
                success.classList.remove('hidden');
            } catch (e) {
                error.textContent = 'Error: ' + e.message;
                error.classList.remove('hidden');
            }
        }

        async function logout() {
            if (!confirm('Cerrar sesion?')) return;
            await db.auth.signOut();
        }

        // ==================== APP INIT ====================
        async function initApp() {
            await Promise.all([loadOrders(), loadStaff()]);
            subscribeToOrders();
        }

        async function loadStaff() {
            try {
                const { data, error } = await db.from('staff').select('id, name, role, phone, is_active').eq('is_active', true).order('name');
                if (error) throw error;
                staffCache = data || [];
            } catch (e) {
                console.error('Error loading staff:', e);
            }
        }

        // ==================== LOAD ORDERS ====================
        function getTodayStart() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d.toISOString();
        }

        async function loadOrders() {
            try {
                const todayStart = getTodayStart();
                const { data, error } = await db
                    .from('orders')
                    .select('*, customers(name, phone)')
                    .gte('created_at', todayStart)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allOrders = data || [];
                allOrders.forEach(o => knownOrderIds.add(o.id));
                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error loading orders:', e);
                showToast('Error cargando pedidos: ' + e.message, 'error');
            }
        }

        // ==================== REALTIME ====================
        function subscribeToOrders() {
            if (realtimeChannel) {
                db.removeChannel(realtimeChannel);
            }

            realtimeChannel = db
                .channel('orders-caja')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'orders'
                }, (payload) => {
                    console.log('Realtime event:', payload.eventType, payload.new?.order_number);
                    handleRealtimeEvent(payload);
                })
                .subscribe((status) => {
                    console.log('Realtime status:', status);
                });
        }

        function handleRealtimeEvent(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            const todayStart = getTodayStart();

            if (eventType === 'INSERT') {
                if (newRecord.created_at >= todayStart) {
                    const isNew = !knownOrderIds.has(newRecord.id);
                    knownOrderIds.add(newRecord.id);

                    const existingIdx = allOrders.findIndex(o => o.id === newRecord.id);
                    if (existingIdx >= 0) {
                        allOrders[existingIdx] = newRecord;
                    } else {
                        allOrders.unshift(newRecord);
                    }

                    if (isNew) {
                        playNotificationSound();
                    }
                }
            } else if (eventType === 'UPDATE') {
                const idx = allOrders.findIndex(o => o.id === newRecord.id);
                if (idx >= 0) {
                    allOrders[idx] = newRecord;
                } else if (newRecord.created_at >= todayStart) {
                    allOrders.unshift(newRecord);
                }
            } else if (eventType === 'DELETE') {
                allOrders = allOrders.filter(o => o.id !== (oldRecord?.id || ''));
                if (selectedOrderId === oldRecord?.id) selectedOrderId = null;
            }

            renderOrderList();
            renderOrderDetail();
            updateStats();
        }

        // ==================== NOTIFICATION SOUND ====================
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc1 = ctx.createOscillator();
                const gain1 = ctx.createGain();
                osc1.connect(gain1);
                gain1.connect(ctx.destination);
                osc1.frequency.value = 880;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, ctx.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc1.start(ctx.currentTime);
                osc1.stop(ctx.currentTime + 0.2);

                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.frequency.value = 1100;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, ctx.currentTime + 0.25);
                gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc2.start(ctx.currentTime + 0.25);
                osc2.stop(ctx.currentTime + 0.5);

                setTimeout(() => ctx.close(), 1000);
            } catch (e) {
                console.warn('Could not play notification sound:', e);
            }
        }

        // ==================== TIME HELPERS ====================
        // Timer: for preparing+ orders, clock starts at confirmed_at
        // Late threshold: 40min for delivery, no late for pickup (their problem)
        function getTimeInfo(order) {
            // For pending orders, show time since creation
            const ref = order.status === 'pending' ? order.created_at : (order.confirmed_at || order.created_at);
            const minutes = Math.floor((Date.now() - new Date(ref)) / 60000);
            const isDelivery = order.delivery_type === 'delivery';
            const lateThreshold = 40; // minutes

            if (order.status === 'pending') {
                // Pending: just show wait time, yellow if > 5min
                if (minutes < 5) return { label: minutes + 'm', color: 'text-gray-400', bg: 'bg-gray-500/10', pulse: false, minutes };
                return { label: minutes + 'm', color: 'text-yellow-400', bg: 'bg-yellow-500/10', pulse: minutes > 10, minutes };
            }

            // For delivery orders: green < 20m, yellow < 30m, orange < 40m, red >= 40m
            if (isDelivery) {
                if (minutes < 20) return { label: minutes + 'm', color: 'text-green-400', bg: 'bg-green-500/10', pulse: false, minutes };
                if (minutes < 30) return { label: minutes + 'm', color: 'text-yellow-400', bg: 'bg-yellow-500/10', pulse: false, minutes };
                if (minutes < lateThreshold) return { label: minutes + 'm', color: 'text-orange-400', bg: 'bg-orange-500/10', pulse: false, minutes };
                return { label: minutes + 'm', color: 'text-red-400 font-bold', bg: 'bg-red-500/10', pulse: true, minutes };
            }

            // For mostrador: green < 20m, yellow < 30m, orange after. No red (their problem).
            if (minutes < 20) return { label: minutes + 'm', color: 'text-green-400', bg: 'bg-green-500/10', pulse: false, minutes };
            if (minutes < 30) return { label: minutes + 'm', color: 'text-yellow-400', bg: 'bg-yellow-500/10', pulse: false, minutes };
            return { label: minutes + 'm', color: 'text-orange-400', bg: 'bg-orange-500/10', pulse: false, minutes };
        }

        function getElapsedLabel(fromDate) {
            if (!fromDate) return '';
            const minutes = Math.floor((Date.now() - new Date(fromDate)) / 60000);
            if (minutes < 1) return 'hace un momento';
            if (minutes < 60) return 'hace ' + minutes + 'm';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return 'hace ' + hours + 'h ' + mins + 'm';
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        function fmt(n) {
            return '$' + parseFloat(n || 0).toLocaleString('es-AR');
        }

        // ==================== MOTHER TAB & SUB TAB LOGIC ====================

        // Orders filtered by mother tab (delivery type)
        function getMotherOrders() {
            if (motherTab === 'mostrador') return allOrders.filter(o => o.delivery_type === 'pickup');
            if (motherTab === 'delivery') return allOrders.filter(o => o.delivery_type === 'delivery');
            if (motherTab === 'salon') return allOrders.filter(o => o.delivery_type === 'local');
            return allOrders; // 'todos'
        }

        // Sub tabs removed ‚Äî unified list with group separators
        function renderSubTabs() { /* no-op: sub-tabs removed */ }

        function switchMotherTab(tab) {
            motherTab = tab;
            document.querySelectorAll('.mother-tab').forEach(btn => {
                if (btn.dataset.mtab === tab) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-500');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('active');
                    btn.classList.remove('text-white');
                    btn.classList.add('text-gray-500');
                }
            });
            renderOrderList();
            renderOrderDetail();
        }

        function switchSubTab(tab) { /* no-op: sub-tabs removed */ }
        function switchTab(tab) { /* no-op: sub-tabs removed */ }

        function onSearchInput(val) {
            searchQuery = val.trim().toLowerCase();
            renderOrderList();
        }

        function getFilteredOrders() {
            let orders = getMotherOrders();

            // Search filter
            if (searchQuery) {
                orders = orders.filter(o => {
                    const num = String(o.order_number || '').toLowerCase();
                    const name = (o.customer_name || extractFromNotes(o.customer_notes, 'Nombre') || '').toLowerCase();
                    const phone = (o.customer_phone || extractFromNotes(o.customer_notes, 'Tel') || '').toLowerCase();
                    return num.includes(searchQuery) || name.includes(searchQuery) || phone.includes(searchQuery);
                });
            }

            // Sort by status priority, then by time within each group
            // preparing(1) before confirmed(2) within EN PREPARACION, ready merges into ENTREGADOS
            const statusPriority = { 'pending': 0, 'preparing': 1, 'confirmed': 2, 'delivering': 3, 'ready': 4, 'delivered': 4, 'cancelled': 5 };
            orders.sort((a, b) => {
                const pa = statusPriority[a.status] ?? 3;
                const pb = statusPriority[b.status] ?? 3;
                if (pa !== pb) return pa - pb;
                // Active orders: oldest first (most urgent on top)
                if (pa <= 3) return new Date(a.created_at) - new Date(b.created_at);
                // Completed/cancelled: most recent first
                return new Date(b.delivered_at || b.updated_at || b.created_at) - new Date(a.delivered_at || a.updated_at || a.created_at);
            });

            return orders;
        }

        // ==================== RENDER ORDER LIST ====================
        function renderOrderList() {
            const orders = getFilteredOrders();
            const container = document.getElementById('order-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                        <span class="text-4xl mb-3">üìã</span>
                        <span class="text-sm">Sin pedidos${searchQuery ? ' para "' + searchQuery + '"' : ''}</span>
                    </div>`;
                return;
            }

            // Group by status for separators
            const groupDefs = [
                { key: 'pending', emoji: '‚è≥', label: 'Pendientes', filter: o => o.status === 'pending' },
                { key: 'preparing', emoji: 'üî•', label: 'En Preparacion', filter: o => o.status === 'preparing' || o.status === 'confirmed' },
                { key: 'delivering', emoji: 'üöö', label: 'En Camino', filter: o => o.status === 'delivering' },
                { key: 'delivered', emoji: 'üì¶', label: 'Entregados', filter: o => o.status === 'delivered' || o.status === 'ready' },
                { key: 'cancelled', emoji: '‚ùå', label: 'Cancelados', filter: o => o.status === 'cancelled' }
            ];

            let html = '';
            for (const group of groupDefs) {
                const groupOrders = orders.filter(group.filter);
                if (groupOrders.length === 0) continue;
                html += `<div class="group-separator">${group.emoji} ${group.label} (${groupOrders.length})</div>`;
                html += groupOrders.map(o => renderOrderRow(o)).join('');
            }

            container.innerHTML = html;
        }

        function renderOrderRow(order) {
            const isSelected = order.id === selectedOrderId;
            const isDelivery = order.delivery_type === 'delivery';
            const customerName = order.customer_name || extractFromNotes(order.customer_notes, 'Nombre') || '';
            const total = fmt(order.total);

            // Status strip class
            let stripClass = 'strip-' + order.status;
            if (order.status === 'confirmed') stripClass = 'strip-confirmed';

            // Time info
            const isActive = ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status);
            let timeHTML = '';
            let isLate = false;
            if (isActive) {
                const ti = getTimeInfo(order);
                isLate = ti.pulse;
                timeHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${ti.bg} ${ti.color} w-14 text-center ${ti.pulse ? 'timer-pulse' : ''}" data-order-id="${order.id}">${ti.label}</span>`;
            } else if (order.status === 'delivered') {
                const deliveredTime = formatTime(order.delivered_at);
                timeHTML = `<span class="text-xs text-gray-500 w-14 text-center">${deliveredTime || '‚úÖ'}</span>`;
            } else if (order.status === 'cancelled') {
                timeHTML = `<span class="text-xs text-red-400/60 w-14 text-center">‚úï</span>`;
            }

            // Quick action: CONFIRMAR is an action button (urgent), rest are status badges
            let quickBtn = '';
            if (order.status === 'pending') {
                quickBtn = `<button onclick="event.stopPropagation(); confirmOrder('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded btn-glow-urgent w-24">CONFIRMAR</button>`;
            } else if (order.status === 'confirmed') {
                quickBtn = `<span class="ml-2 text-xs font-bold px-3 py-1.5 rounded status-badge-confirmed w-24 text-center inline-block">CONFIRMADO</span>`;
            } else if ((order.status === 'preparing' || order.status === 'confirmed') && isDelivery) {
                quickBtn = `<button onclick="event.stopPropagation(); openEnviarModal('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded btn-glow-blue w-24">ENVIAR</button>`;
            } else if (order.status === 'preparing' || order.status === 'confirmed') {
                quickBtn = `<span class="ml-2 text-xs font-bold px-3 py-1.5 rounded status-badge-preparing w-24 text-center inline-block">PREPARANDO</span>`;
            } else if (order.status === 'ready') {
                quickBtn = `<span class="ml-2 text-xs font-bold px-3 py-1.5 rounded status-badge-ready w-24 text-center inline-block">LISTO</span>`;
            } else if (order.status === 'delivering') {
                quickBtn = `<button onclick="event.stopPropagation(); markDelivered('${order.id}')" class="ml-2 text-xs font-bold px-3 py-1.5 rounded btn-glow-green w-24">ENTREGADO</button>`;
            }

            const completedClass = (order.status === 'delivered' || order.status === 'cancelled') ? 'opacity-50' : '';
            const totalClass = order.status === 'cancelled' ? 'line-through text-red-400/60' : 'text-white';

            return `
            <div class="order-row flex items-center px-3 py-2.5 border-b border-white/5 cursor-pointer ${isSelected ? 'selected' : ''} ${isLate && !isSelected ? 'late' : ''} ${completedClass}"
                 onclick="selectOrder('${order.id}')">
                <div class="status-strip ${stripClass} self-stretch mr-3"></div>
                <span class="font-bold text-base w-14 text-white">#${order.order_number || '---'}</span>
                <span class="w-7 text-center text-sm">${isDelivery ? 'üöö' : 'üè™'}</span>
                <span class="flex-1 truncate text-sm text-gray-300 px-2">${customerName || '‚Äî'}${isDelivery && order.assigned_to ? ` <span class="text-xs text-blue-400">¬∑ ${order.assigned_to}</span>` : ''}</span>
                ${timeHTML}
                <span class="font-bold text-sm w-20 text-right ${totalClass}">${total}</span>
                ${quickBtn}
            </div>`;
        }

        // ==================== RENDER ORDER DETAIL ====================
        function renderOrderDetail() {
            const container = document.getElementById('order-detail');

            if (!selectedOrderId) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <svg class="w-16 h-16 mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="text-base font-medium text-gray-400">Selecciona un pedido de la lista</p>
                        <p class="text-sm mt-1 text-gray-600">Usa las flechas o haz click en un pedido</p>
                    </div>`;
                return;
            }

            const order = allOrders.find(o => o.id === selectedOrderId);
            if (!order) {
                selectedOrderId = null;
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <p class="text-sm">Pedido no encontrado</p>
                    </div>`;
                return;
            }

            const isDelivery = order.delivery_type === 'delivery';
            const customerName = order.customer_name || order.customers?.name || extractFromNotes(order.customer_notes, 'Nombre') || '';
            const customerPhone = order.customer_phone || order.customers?.phone || extractFromNotes(order.customer_notes, 'Tel') || '';
            const address = isDelivery ? (order.delivery_address || '') : '';
            const items = order.items || [];

            // Status badge with glow
            const statusMap = {
                'pending': { label: 'PENDIENTE', cls: 'status-badge-pending' },
                'confirmed': { label: 'CONFIRMADO', cls: 'status-badge-confirmed' },
                'preparing': { label: 'PREPARANDO', cls: 'status-badge-preparing' },
                'ready': { label: 'LISTO', cls: 'status-badge-ready' },
                'delivering': { label: 'ENVIADO', cls: 'status-badge-delivering' },
                'delivered': { label: 'ENTREGADO', cls: 'status-badge-delivered' },
                'cancelled': { label: 'CANCELADO', cls: 'status-badge-cancelled' }
            };
            const st = statusMap[order.status] || statusMap['pending'];

            // Time info
            const isActive = ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status);
            let timeSection = '';
            if (isActive) {
                const ti = getTimeInfo(order);
                timeSection = `<span class="text-lg font-bold ${ti.color} ${ti.pulse ? 'timer-pulse' : ''}">${ti.label}</span>`;
            }

            // Items HTML - dark
            const itemsHTML = items.map((item, idx) => {
                const itemSubtotal = fmt(item.subtotal || (item.price * item.quantity) || 0);
                let obsLine = '';
                if (item.obs) obsLine += `<p class="text-xs text-gray-500 italic ml-7">obs: ${item.obs}</p>`;
                if (item.cooking_method) {
                    const cm = item.cooking_method === 'frito' ? 'Frita' : item.cooking_method === 'horno' ? 'Al Horno' : item.cooking_method;
                    obsLine += `<p class="text-xs text-orange-400 ml-7">[${cm}]</p>`;
                }

                let deleteReasonHTML = '';
                if (deletingItemIndex === idx && selectedOrderId === order.id) {
                    deleteReasonHTML = `
                        <div class="ml-7 mt-1 flex items-center space-x-2 bg-red-500/10 rounded px-2 py-1.5">
                            <span class="text-xs text-red-400 font-medium whitespace-nowrap">Motivo?</span>
                            <select id="delete-reason-${idx}" class="text-xs bg-white/5 border border-white/10 text-white rounded px-2 py-1 flex-1">
                                <option value="Cliente cancelo">Cliente cancelo</option>
                                <option value="Sin stock">Sin stock</option>
                                <option value="Error de carga">Error de carga</option>
                                <option value="Cambio de pedido">Cambio de pedido</option>
                            </select>
                            <button onclick="confirmRemoveItem('${order.id}', ${idx})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 font-bold">Eliminar</button>
                            <button onclick="cancelDeleteItem()" class="text-xs text-gray-500 hover:text-gray-300">&times;</button>
                        </div>`;
                }

                const isEditable = !['delivered', 'cancelled', 'delivering'].includes(order.status);

                return `
                <div class="py-2 ${idx > 0 ? 'border-t border-white/5' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            <span class="font-semibold text-sm w-7 text-white">${item.quantity}x</span>
                            <span class="text-sm text-gray-300 truncate">${item.name}</span>
                        </div>
                        <span class="text-sm font-medium text-gray-400 ml-2 whitespace-nowrap">${itemSubtotal}</span>
                    </div>
                    ${obsLine}
                    ${isEditable ? `
                    <div class="ml-7 mt-1 flex items-center space-x-1">
                        <button onclick="editItemQuantity('${order.id}', ${idx}, 1)" class="w-6 h-6 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-gray-400 text-sm font-bold transition" title="Agregar 1">+</button>
                        <button onclick="editItemQuantity('${order.id}', ${idx}, -1)" class="w-6 h-6 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-gray-400 text-sm font-bold transition" title="Quitar 1">&minus;</button>
                        <button onclick="startDeleteItem(${idx})" class="w-6 h-6 flex items-center justify-center rounded bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs transition" title="Eliminar item">üóëÔ∏è</button>
                    </div>
                    ` : ''}
                    ${deleteReasonHTML}
                </div>`;
            }).join('');

            // Totals
            const subtotal = items.reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);
            const discount = parseFloat(order.discount || 0);
            const total = parseFloat(order.total || 0);

            // Main action button with glow
            let mainActionHTML = '';
            if (order.status === 'pending') {
                mainActionHTML = `<button onclick="confirmOrder('${order.id}')" class="w-full py-3 rounded-lg font-bold text-sm btn-glow-urgent">‚úì CONFIRMAR PEDIDO</button>`;
            } else if (order.status === 'confirmed' || order.status === 'preparing') {
                if (isDelivery) {
                    mainActionHTML = `<button onclick="openEnviarModal('${order.id}')" class="w-full py-3 rounded-lg font-bold text-sm btn-glow-blue">üöö ENVIAR CON CADETE</button>`;
                } else {
                    mainActionHTML = `<button onclick="markDelivered('${order.id}')" class="w-full py-3 rounded-lg font-bold text-sm btn-glow-green">‚úì MARCAR ENTREGADO</button>`;
                }
            } else if (order.status === 'delivering') {
                mainActionHTML = `<button onclick="markDelivered('${order.id}')" class="w-full py-3 rounded-lg font-bold text-sm btn-glow-green">‚úì MARCAR ENTREGADO</button>`;
            }

            // Timeline
            let timelineHTML = '';
            const timelineSteps = [];
            if (order.created_at) timelineSteps.push({ label: 'Creado', time: order.created_at });
            if (order.confirmed_at) timelineSteps.push({ label: 'Confirmado', time: order.confirmed_at });
            if (order.ready_at) timelineSteps.push({ label: 'Listo', time: order.ready_at });
            if (order.delivering_at) timelineSteps.push({ label: 'Enviado', time: order.delivering_at });
            if (order.delivered_at) timelineSteps.push({ label: 'Entregado', time: order.delivered_at });

            timelineHTML = timelineSteps.map(s => {
                return `<div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${s.label}</span>
                    <span>${formatTime(s.time)} (${getElapsedLabel(s.time)})</span>
                </div>`;
            }).join('');

            const canEdit = !['delivered', 'cancelled', 'delivering'].includes(order.status);

            container.innerHTML = `
            <div class="detail-enter">
                <!-- Header -->
                <div class="px-5 pt-5 pb-3 border-b border-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-bold text-white">#${order.order_number || '---'}</span>
                            <span class="text-xs font-bold px-2.5 py-1 rounded-full ${st.cls}">${st.label}</span>
                        </div>
                        ${timeSection}
                    </div>
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-sm font-bold ${isDelivery ? 'text-blue-400' : 'text-green-400'}">${isDelivery ? 'üöö DELIVERY' : 'üè™ RETIRA EN LOCAL'}</span>
                    </div>
                    ${address ? `<p class="text-sm text-gray-400 mb-0.5">${address}</p>` : ''}
                    ${customerName ? `<p class="text-sm text-gray-300 font-medium">${customerName}</p>` : ''}
                    ${customerPhone ? `<p class="text-sm text-gray-500"><a href="tel:${customerPhone}" class="hover:text-blue-400 underline decoration-dotted">${customerPhone}</a></p>` : ''}
                </div>

                <!-- Items -->
                <div class="px-5 py-3 border-b border-white/5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Items</h3>
                    ${itemsHTML || '<p class="text-sm text-gray-600">Sin items</p>'}
                    ${canEdit ? `
                    <button onclick="openAddItemModal('${order.id}')" class="mt-3 w-full py-2 text-sm font-medium text-blue-400 border border-blue-500/20 rounded-lg hover:bg-blue-500/10 transition">+ Agregar item</button>
                    ` : ''}
                </div>

                <!-- Totals + Discount -->
                <div class="px-5 py-3 border-b border-white/5">
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm text-gray-400">
                            <span>Subtotal</span>
                            <span>${fmt(subtotal)}</span>
                        </div>
                        ${deliveryFee > 0 ? `
                        <div class="flex justify-between text-sm text-blue-400">
                            <span>Envio</span>
                            <span>${fmt(deliveryFee)}</span>
                        </div>` : ''}
                        ${discount > 0 ? `
                        <div class="flex justify-between text-sm text-red-400">
                            <span>Descuento${order.discount_reason ? ' (' + order.discount_reason + ')' : ''}</span>
                            <span>-${fmt(discount)}</span>
                        </div>` : ''}
                        <div class="flex justify-between text-lg font-bold text-white pt-1 border-t border-white/10">
                            <span>TOTAL</span>
                            <span>${fmt(total)}</span>
                        </div>
                    </div>
                    ${canEdit ? `
                    <div class="mt-3 pt-2 border-t border-white/5">
                        ${discount > 0 ? `
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-red-400 font-medium">Descuento aplicado: -${fmt(discount)}</span>
                            <button onclick="removeDiscount('${order.id}')" class="text-xs text-red-400 hover:text-red-300 underline">Quitar</button>
                        </div>
                        ` : `
                        <div id="discount-form-${order.id}">
                            <button onclick="showDiscountForm('${order.id}')" class="w-full py-1.5 text-xs font-medium text-orange-400 border border-orange-500/20 rounded-lg hover:bg-orange-500/10 transition">Aplicar descuento</button>
                        </div>
                        `}
                    </div>
                    ` : ''}
                </div>

                <!-- Payment -->
                <div class="px-5 py-3 border-b border-white/5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Medio de pago</h3>
                    <select onchange="updatePaymentMethod('${order.id}', this.value)" class="w-full bg-white/5 border border-white/10 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="cash" ${order.payment_method === 'cash' ? 'selected' : ''}>üíµ Efectivo</option>
                        <option value="debit_card" ${order.payment_method === 'debit_card' ? 'selected' : ''}>üí≥ Tarj. Debito</option>
                        <option value="credit_card" ${order.payment_method === 'credit_card' ? 'selected' : ''}>üí≥ Tarj. Credito</option>
                        <option value="mercadopago" ${order.payment_method === 'mercadopago' ? 'selected' : ''}>üì≤ Mercado Pago</option>
                        <option value="qr" ${order.payment_method === 'qr' ? 'selected' : ''}>üì± QR</option>
                        <option value="prepaid_card" ${order.payment_method === 'prepaid_card' ? 'selected' : ''}>üí≥ Prepaga</option>
                        <option value="transfer" ${order.payment_method === 'transfer' ? 'selected' : ''}>üè¶ Transferencia</option>
                    </select>
                </div>

                <!-- Cadete / Mozo assignment -->
                ${isDelivery ? `
                <div class="px-5 py-3 border-b border-white/5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Cadete asignado</h3>
                    <div class="flex items-center space-x-2">
                        <select onchange="assignStaff('${order.id}', this.value)" class="flex-1 bg-white/5 border border-white/10 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Sin asignar</option>
                            ${staffCache.filter(s => s.role === 'cadete').map(s => `<option value="${s.name}" ${order.assigned_to === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                        <button onclick="openStaffManager()" class="px-2 py-2 text-gray-500 hover:text-blue-400 transition" title="Administrar cadetes">‚öôÔ∏è</button>
                    </div>
                </div>
                ` : ''}

                <!-- Timeline -->
                <div class="px-5 py-3 border-b border-white/5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Historial</h3>
                    <div class="space-y-1">
                        ${timelineHTML}
                    </div>
                </div>

                <!-- Actions -->
                <div class="px-5 py-4">
                    ${mainActionHTML ? `<div class="mb-3">${mainActionHTML}</div>` : ''}
                    <div class="flex items-center space-x-2 mb-3">
                        <button onclick="reprintOrder('${order.id}')" class="flex-1 py-2.5 text-sm font-medium bg-white/5 border border-white/10 hover:bg-white/10 text-gray-300 rounded-lg transition">üñ®Ô∏è Reimprimir</button>
                        <button onclick="notifyCustomerWhatsApp('${order.id}', '${order_whatsapp_event(order.status)}')" class="flex-1 py-2.5 text-sm font-medium bg-white/5 border border-white/10 hover:bg-white/10 text-gray-300 rounded-lg transition">üí¨ WhatsApp</button>
                    </div>
                    ${order.status !== 'cancelled' && order.status !== 'delivered' ? `
                    <button onclick="cancelOrder('${order.id}')" class="w-full py-2 text-sm font-medium text-red-400 border border-red-500/20 rounded-lg hover:bg-red-500/10 transition">‚ùå Cancelar pedido</button>
                    ` : ''}
                </div>
            </div>`;
        }

        function order_whatsapp_event(status) {
            if (status === 'pending') return 'confirmed';
            if (status === 'confirmed' || status === 'preparing') return 'ready';
            if (status === 'ready') return 'delivering';
            if (status === 'delivering') return 'delivering';
            return 'ready';
        }

        // ==================== SELECT ORDER ====================
        function selectOrder(orderId) {
            selectedOrderId = orderId;
            deletingItemIndex = null;
            renderOrderList();
            renderOrderDetail();
        }

        function selectNextOrder() {
            const orders = getFilteredOrders();
            if (orders.length === 0) return;
            if (!selectedOrderId) {
                selectOrder(orders[0].id);
                return;
            }
            const idx = orders.findIndex(o => o.id === selectedOrderId);
            if (idx < orders.length - 1) {
                selectOrder(orders[idx + 1].id);
            }
        }

        function selectPrevOrder() {
            const orders = getFilteredOrders();
            if (orders.length === 0) return;
            if (!selectedOrderId) {
                selectOrder(orders[0].id);
                return;
            }
            const idx = orders.findIndex(o => o.id === selectedOrderId);
            if (idx > 0) {
                selectOrder(orders[idx - 1].id);
            }
        }

        // ==================== ITEM EDITING ====================
        async function editItemQuantity(orderId, itemIndex, delta) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) return;

            const items = [...order.items];
            items[itemIndex] = { ...items[itemIndex] };
            items[itemIndex].quantity = Math.max(1, (items[itemIndex].quantity || 1) + delta);
            items[itemIndex].subtotal = items[itemIndex].quantity * (items[itemIndex].price || 0);

            await updateOrderInDB(orderId, items);
        }

        function startDeleteItem(itemIndex) {
            deletingItemIndex = itemIndex;
            renderOrderDetail();
        }

        function cancelDeleteItem() {
            deletingItemIndex = null;
            renderOrderDetail();
        }

        async function confirmRemoveItem(orderId, itemIndex) {
            const reasonEl = document.getElementById('delete-reason-' + itemIndex);
            const reason = reasonEl ? reasonEl.value : 'Sin motivo';

            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) return;

            const removedItem = order.items[itemIndex];
            console.log('Item eliminado:', removedItem.name, '| Motivo:', reason, '| Pedido #' + order.order_number);

            const items = order.items.filter((_, i) => i !== itemIndex);
            deletingItemIndex = null;

            await updateOrderInDB(orderId, items);
            showToast('Item eliminado: ' + removedItem.name, 'info');
        }

        async function updateOrderInDB(orderId, newItems) {
            try {
                // Recalculate total
                const order = allOrders.find(o => o.id === orderId);
                if (!order) return;

                const subtotal = newItems.reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
                const deliveryFee = parseFloat(order.delivery_fee || 0);
                const discount = parseFloat(order.discount || 0);
                const newTotal = subtotal + deliveryFee - discount;

                const { error } = await db.from('orders').update({
                    items: newItems,
                    subtotal: subtotal,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                // Update local state
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].items = newItems;
                    allOrders[idx].subtotal = subtotal;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error al actualizar: ' + e.message, 'error');
            }
        }

        // ==================== DISCOUNT ====================
        function showDiscountForm(orderId) {
            const container = document.getElementById('discount-form-' + orderId);
            if (!container) return;
            container.innerHTML = `
                <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3 space-y-2">
                    <div class="flex space-x-2">
                        <label class="flex items-center space-x-1 text-xs cursor-pointer text-gray-300">
                            <input type="radio" name="disc-type-${orderId}" value="percent" checked class="accent-orange-500"> <span>%</span>
                        </label>
                        <label class="flex items-center space-x-1 text-xs cursor-pointer text-gray-300">
                            <input type="radio" name="disc-type-${orderId}" value="fixed" class="accent-orange-500"> <span>$ Fijo</span>
                        </label>
                    </div>
                    <input type="number" id="disc-value-${orderId}" min="0" step="any" placeholder="Valor" class="w-full bg-white/5 border border-white/10 text-white rounded px-2 py-1.5 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="text" id="disc-reason-${orderId}" placeholder="Motivo (opcional)" class="w-full bg-white/5 border border-white/10 text-white rounded px-2 py-1.5 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <div class="flex space-x-2">
                        <button onclick="applyDiscount('${orderId}')" class="flex-1 py-1.5 text-xs font-bold btn-glow-orange rounded-lg">Aplicar</button>
                        <button onclick="renderOrderDetail()" class="flex-1 py-1.5 text-xs font-medium text-gray-400 bg-white/5 hover:bg-white/10 rounded-lg transition">Cancelar</button>
                    </div>
                </div>`;
            document.getElementById('disc-value-' + orderId).focus();
        }

        async function applyDiscount(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const typeRadio = document.querySelector(`input[name="disc-type-${orderId}"]:checked`);
            const discType = typeRadio ? typeRadio.value : 'percent';
            const rawValue = parseFloat(document.getElementById('disc-value-' + orderId).value);
            const reason = (document.getElementById('disc-reason-' + orderId).value || '').trim();

            if (!rawValue || rawValue <= 0) {
                showToast('Ingresa un valor de descuento', 'error');
                return;
            }

            const subtotal = (order.items || []).reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);

            let discount;
            if (discType === 'percent') {
                if (rawValue > 100) { showToast('El porcentaje no puede ser mayor a 100%', 'error'); return; }
                discount = Math.round(subtotal * rawValue / 100);
            } else {
                discount = rawValue;
            }

            const baseTotal = subtotal + deliveryFee;
            if (discount > baseTotal) { showToast('El descuento supera el total', 'error'); return; }

            const newTotal = baseTotal - discount;
            const discountReason = discType === 'percent' ? `${rawValue}%${reason ? ' - ' + reason : ''}` : (reason || '');

            try {
                const { error } = await db.from('orders').update({
                    discount: discount,
                    discount_reason: discountReason,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].discount = discount;
                    allOrders[idx].discount_reason = discountReason;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
                showToast(`Descuento de ${fmt(discount)} aplicado`, 'success');
            } catch (e) {
                console.error('Error applying discount:', e);
                showToast('Error al aplicar descuento: ' + e.message, 'error');
            }
        }

        async function removeDiscount(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const subtotal = (order.items || []).reduce((s, i) => s + ((i.subtotal || (i.price * i.quantity)) || 0), 0);
            const deliveryFee = parseFloat(order.delivery_fee || 0);
            const newTotal = subtotal + deliveryFee;

            try {
                const { error } = await db.from('orders').update({
                    discount: 0,
                    discount_reason: null,
                    total: newTotal,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].discount = 0;
                    allOrders[idx].discount_reason = null;
                    allOrders[idx].total = newTotal;
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                renderOrderList();
                renderOrderDetail();
                updateStats();
                showToast('Descuento eliminado', 'info');
            } catch (e) {
                console.error('Error removing discount:', e);
                showToast('Error al quitar descuento: ' + e.message, 'error');
            }
        }

        // ==================== STAFF / CADETES ====================
        async function assignStaff(orderId, staffName) {
            try {
                const { error } = await db.from('orders').update({
                    assigned_to: staffName || null,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);
                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].assigned_to = staffName || null;
                    allOrders[idx].updated_at = new Date().toISOString();
                }
                renderOrderList();
                if (staffName) showToast(`Cadete asignado: ${staffName}`, 'success');
            } catch (e) {
                console.error('Error assigning staff:', e);
                showToast('Error al asignar cadete: ' + e.message, 'error');
            }
        }

        function openStaffManager() {
            document.getElementById('modal-staff').classList.remove('hidden');
            renderStaffList();
        }

        function closeStaffManager() {
            document.getElementById('modal-staff').classList.add('hidden');
        }

        function renderStaffList() {
            const container = document.getElementById('staff-list');
            const cadetes = staffCache.filter(s => s.role === 'cadete');
            container.innerHTML = cadetes.map(s => `
                <div class="flex items-center justify-between py-2 px-3 bg-white/5 rounded-lg border border-white/5">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">üèçÔ∏è</span>
                        <div>
                            <p class="text-sm font-medium text-gray-200">${s.name}</p>
                            ${s.phone ? `<p class="text-xs text-gray-500">${s.phone}</p>` : ''}
                        </div>
                    </div>
                    <button onclick="removeStaffMember('${s.id}')" class="text-xs text-red-400 hover:text-red-300">Eliminar</button>
                </div>
            `).join('') || '<p class="text-sm text-gray-500 text-center py-4">No hay cadetes</p>';
        }

        async function addStaffMember() {
            const nameInput = document.getElementById('new-staff-name');
            const name = (nameInput.value || '').trim();
            if (!name) { showToast('Ingresa un nombre', 'error'); return; }

            try {
                const { data, error } = await db.from('staff').insert({ name, role: 'cadete' }).select().single();
                if (error) throw error;
                staffCache.push(data);
                nameInput.value = '';
                renderStaffList();
                renderOrderDetail();
                showToast(`Cadete "${name}" agregado`, 'success');
            } catch (e) {
                console.error('Error adding staff:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function removeStaffMember(staffId) {
            try {
                const { error } = await db.from('staff').update({ is_active: false }).eq('id', staffId);
                if (error) throw error;
                staffCache = staffCache.filter(s => s.id !== staffId);
                renderStaffList();
                renderOrderDetail();
                showToast('Cadete eliminado', 'info');
            } catch (e) {
                console.error('Error removing staff:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== ADD ITEM MODAL ====================
        async function loadProducts() {
            if (productsCache.length > 0) return;
            try {
                const { data, error } = await db.from('products').select('id, name, price, category_id, slug').order('name');
                if (error) throw error;
                productsCache = data || [];
            } catch (e) {
                console.error('Error loading products:', e);
                showToast('Error cargando productos: ' + e.message, 'error');
            }
        }

        async function openAddItemModal(orderId) {
            addItemOrderId = orderId;
            document.getElementById('modal-add-item').classList.remove('hidden');
            document.getElementById('product-search-input').value = '';
            document.getElementById('product-search-input').focus();
            await loadProducts();
            renderProductGrid(productsCache);
        }

        function closeAddItemModal() {
            document.getElementById('modal-add-item').classList.add('hidden');
            addItemOrderId = null;
        }

        function filterProducts(query) {
            const q = query.toLowerCase().trim();
            if (!q) {
                renderProductGrid(productsCache);
                return;
            }
            const filtered = productsCache.filter(p => (p.name || '').toLowerCase().includes(q));
            renderProductGrid(filtered);
        }

        let filteredProductsCache = [];
        function renderProductGrid(products) {
            filteredProductsCache = products;
            const container = document.getElementById('product-grid');
            if (products.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-12">No se encontraron productos</div>';
                return;
            }
            container.innerHTML = products.map((p, idx) => `
                <button onclick="addProductByIndex(${idx})"
                        class="bg-white/5 border border-white/10 rounded-lg p-3 hover:border-orange-500/50 hover:bg-white/10 transition text-left">
                    <p class="text-sm font-medium text-gray-200 truncate">${p.name}</p>
                    <p class="text-sm font-bold text-orange-400 mt-1">${fmt(p.price)}</p>
                </button>
            `).join('');
        }

        function addProductByIndex(idx) {
            const product = filteredProductsCache[idx];
            if (product && addItemOrderId) addItemToOrder(addItemOrderId, product);
        }

        async function addItemToOrder(orderId, product) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const newItem = {
                name: product.name,
                price: product.price || 0,
                quantity: 1,
                subtotal: product.price || 0,
                slug: product.slug || '',
                product_id: product.id || null
            };

            const items = [...(order.items || []), newItem];
            closeAddItemModal();
            await updateOrderInDB(orderId, items);
            showToast('Agregado: ' + product.name, 'success');
        }

        // ==================== CANCEL ORDER ====================
        async function cancelOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            if (!confirm('Cancelar pedido #' + (order.order_number || '') + '?\n\nEsta accion no se puede deshacer.')) return;

            try {
                const { error } = await db.from('orders').update({
                    status: 'cancelled',
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'cancelled';
                    allOrders[idx].updated_at = new Date().toISOString();
                }

                showToast('Pedido #' + order.order_number + ' cancelado', 'error');
                renderOrderList();
                renderOrderDetail();
                updateStats();
            } catch (e) {
                console.error('Error cancelling order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== STATS ====================
        function updateStats() {
            const todayOrders = allOrders.filter(o => o.status !== 'cancelled');
            const revenue = todayOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
            const count = todayOrders.length;
            const avg = count > 0 ? Math.round(revenue / count) : 0;

            document.getElementById('stat-revenue').textContent = fmt(revenue);
            document.getElementById('stat-count').textContent = count;
            document.getElementById('stat-avg').textContent = fmt(avg);

            // Late orders badge - only delivery orders > 40min since confirmed
            const lateOrders = allOrders.filter(o => {
                if (o.delivery_type !== 'delivery') return false;
                if (!['confirmed', 'preparing', 'ready', 'delivering'].includes(o.status)) return false;
                const ref = o.confirmed_at || o.created_at;
                const minutes = Math.floor((Date.now() - new Date(ref)) / 60000);
                return minutes >= 40;
            });

            const badge = document.getElementById('late-badge');
            if (lateOrders.length > 0) {
                badge.textContent = 'üî¥ ' + lateOrders.length + ' demorado' + (lateOrders.length > 1 ? 's' : '');
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==================== ORDER STATUS UPDATES ====================
        // Store pending confirmation order ID for time picker
        let pendingConfirmOrderId = null;

        function confirmOrder(orderId) {
            // Show time picker instead of confirming directly
            pendingConfirmOrderId = orderId;
            document.getElementById('modal-tiempo').classList.remove('hidden');
        }

        function closeTimePicker() {
            pendingConfirmOrderId = null;
            document.getElementById('modal-tiempo').classList.add('hidden');
        }

        function selectTime(minutes) {
            if (!pendingConfirmOrderId) return;
            const orderId = pendingConfirmOrderId;
            closeTimePicker();
            doConfirmOrder(orderId, minutes);
        }

        async function doConfirmOrder(orderId, estimatedMinutes) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'confirmed',
                    confirmed_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast(`Pedido confirmado (${estimatedMinutes} min)`, 'success');

                // Impresion automatica via Supabase trigger (create_print_jobs_for_order)
                // No se necesita llamar a printOrder(), el trigger crea los print_jobs
                // y la app Electron los recibe via Realtime

                // Notificar cliente por WhatsApp con tiempo estimado
                notifyCustomerWhatsApp(orderId, 'confirmed', estimatedMinutes);

                // Update local state immediately
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'confirmed';
                    allOrders[idx].confirmed_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error confirming order:', e);
                showToast('Error al confirmar: ' + e.message, 'error');
            }
        }

        async function markReady(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'ready',
                    ready_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido listo', 'success');

                // Notificar cliente por WhatsApp
                notifyCustomerWhatsApp(orderId, 'ready');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'ready';
                    allOrders[idx].ready_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== ENVIAR PEDIDO (cadete + notify) ====================
        let enviarOrderId = null;

        function openEnviarModal(orderId) {
            enviarOrderId = orderId;
            const container = document.getElementById('enviar-cadetes');
            const cadeteList = staffCache.filter(s => s.role === 'cadete');

            if (cadeteList.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center py-4">No hay cadetes. Agrega desde ‚öôÔ∏è en el detalle del pedido.</p>`;
            } else {
                container.innerHTML = cadeteList.map(c => `
                    <button onclick="enviarConCadete('${c.name}')" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-white/5 border border-white/10 hover:border-blue-500 hover:bg-blue-500/10 transition text-left">
                        <span class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-sm font-bold">${c.name.charAt(0).toUpperCase()}</span>
                        <span class="text-white font-medium">${c.name}</span>
                    </button>
                `).join('');
            }
            document.getElementById('modal-enviar').classList.remove('hidden');
        }

        function closeEnviarModal() {
            document.getElementById('modal-enviar').classList.add('hidden');
            enviarOrderId = null;
        }

        async function enviarConCadete(cadeteName) {
            if (!enviarOrderId) return;
            const orderId = enviarOrderId;
            closeEnviarModal();

            try {
                const { error } = await db.from('orders').update({
                    status: 'delivering',
                    delivering_at: new Date().toISOString(),
                    assigned_to: cadeteName,
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;
                showToast(`Pedido enviado con ${cadeteName}`, 'success');

                // Notificar cliente por WhatsApp con nombre del cadete
                notifyCustomerWhatsApp(orderId, 'delivering', null, cadeteName);

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'delivering';
                    allOrders[idx].delivering_at = new Date().toISOString();
                    allOrders[idx].assigned_to = cadeteName;
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    if (selectedOrderId === orderId) renderOrderDetail();
                }
            } catch (e) {
                console.error('Error enviando pedido:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function markDelivering(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'delivering',
                    delivering_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido enviado', 'success');

                // Notificar cliente por WhatsApp
                notifyCustomerWhatsApp(orderId, 'delivering');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'delivering';
                    allOrders[idx].delivering_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function markDelivered(orderId) {
            try {
                const { error } = await db.from('orders').update({
                    status: 'delivered',
                    delivered_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;

                showToast('Pedido entregado', 'success');

                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) {
                    allOrders[idx].status = 'delivered';
                    allOrders[idx].delivered_at = new Date().toISOString();
                    allOrders[idx].updated_at = new Date().toISOString();
                    renderOrderList();
                    renderOrderDetail();
                }
            } catch (e) {
                console.error('Error updating order:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== EXECUTE MAIN ACTION (for Enter key) ====================
        function executeMainAction() {
            if (!selectedOrderId) return;
            const order = allOrders.find(o => o.id === selectedOrderId);
            if (!order) return;
            const isDelivery = order.delivery_type === 'delivery';
            if (order.status === 'pending') confirmOrder(order.id);
            else if ((order.status === 'confirmed' || order.status === 'preparing') && isDelivery) openEnviarModal(order.id);
            else if ((order.status === 'confirmed' || order.status === 'preparing') && !isDelivery) markDelivered(order.id);
            else if (order.status === 'delivering') markDelivered(order.id);
        }

        // ==================== REIMPRIMIR PEDIDO ====================
        // Crea print_jobs en Supabase para que la app Electron los recoja
        async function reprintOrder(orderId) {
            try {
                let order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    const { data, error } = await db.from('orders').select('*').eq('id', orderId).single();
                    if (error || !data) { showToast('Error obteniendo pedido', 'error'); return; }
                    order = data;
                }

                // Forzar re-ejecucion del trigger: marcar y volver a confirmed
                const { error } = await db.from('orders').update({
                    status: 'confirmed',
                    updated_at: new Date().toISOString()
                }).eq('id', orderId);

                if (error) throw error;
                showToast(`Reimpresion solicitada para #${order.order_number}`, 'success');
            } catch (e) {
                console.error('Error reimprimiendo:', e);
                showToast('Error al reimprimir: ' + e.message, 'error');
            }
        }

        // ==================== PAGO ====================
        async function updatePaymentMethod(orderId, method) {
            try {
                await db.from('orders').update({ payment_method: method, updated_at: new Date().toISOString() }).eq('id', orderId);
                const idx = allOrders.findIndex(o => o.id === orderId);
                if (idx >= 0) allOrders[idx].payment_method = method;
                updateStats();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        // ==================== CIERRE DE CAJA ====================
        async function openCierreCaja() {
            document.getElementById('modal-cierre').classList.remove('hidden');
            renderCierre();
        }

        function closeCierreCaja() {
            document.getElementById('modal-cierre').classList.add('hidden');
        }

        function getCierreOrders() {
            const turno = document.getElementById('cierre-turno').value;
            let orders = allOrders.filter(o => o.status !== 'cancelled');

            if (turno === 'noon') {
                orders = orders.filter(o => {
                    const h = new Date(o.created_at).getHours();
                    return h >= 11 && h < 16;
                });
            } else if (turno === 'night') {
                orders = orders.filter(o => {
                    const h = new Date(o.created_at).getHours();
                    return h >= 18 || h < 2;
                });
            }
            return orders;
        }

        function renderCierre() {
            const orders = getCierreOrders();
            const delivered = orders.filter(o => o.status === 'delivered');
            const active = orders.filter(o => o.status !== 'delivered');

            // Cancelled orders (separate from getCierreOrders which excludes them)
            const turno = document.getElementById('cierre-turno').value;
            let cancelledOrders = allOrders.filter(o => o.status === 'cancelled');
            if (turno === 'noon') {
                cancelledOrders = cancelledOrders.filter(o => { const h = new Date(o.created_at).getHours(); return h >= 11 && h < 16; });
            } else if (turno === 'night') {
                cancelledOrders = cancelledOrders.filter(o => { const h = new Date(o.created_at).getHours(); return h >= 18 || h < 2; });
            }
            const cancelledTotal = cancelledOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

            const totalVentas = orders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
            const totalDeliveryFees = orders.reduce((s, o) => s + parseFloat(o.delivery_fee || 0), 0);
            const totalDiscounts = orders.reduce((s, o) => s + parseFloat(o.discount || 0), 0);
            const count = orders.length;
            const avg = count > 0 ? Math.round(totalVentas / count) : 0;

            // By delivery type
            const deliveryOrders = orders.filter(o => o.delivery_type === 'delivery');
            const pickupOrders = orders.filter(o => o.delivery_type === 'pickup');
            const deliveryTotal = deliveryOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
            const pickupTotal = pickupOrders.reduce((s, o) => s + parseFloat(o.total || 0), 0);

            // By payment method
            const byPayment = {};
            for (const o of orders) {
                const m = o.payment_method || 'cash';
                if (!byPayment[m]) byPayment[m] = { count: 0, total: 0 };
                byPayment[m].count++;
                byPayment[m].total += parseFloat(o.total || 0);
            }

            // Top products
            const productCount = {};
            for (const o of orders) {
                for (const item of (o.items || [])) {
                    const name = item.name || 'Desconocido';
                    if (!productCount[name]) productCount[name] = 0;
                    productCount[name] += item.quantity || 1;
                }
            }
            const topProducts = Object.entries(productCount).sort((a, b) => b[1] - a[1]).slice(0, 8);

            const turnoLabel = document.getElementById('cierre-turno').selectedOptions[0].text;
            const fecha = new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            document.getElementById('cierre-content').innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm">${fecha} - ${turnoLabel}</p>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4 text-center">
                        <p class="text-green-400 text-sm font-medium">Total Ventas</p>
                        <p class="text-2xl font-bold text-green-400">${fmt(totalVentas)}</p>
                    </div>
                    <div class="bg-orange-500/10 border border-orange-500/20 rounded-xl p-4 text-center">
                        <p class="text-orange-400 text-sm font-medium">Pedidos</p>
                        <p class="text-2xl font-bold text-orange-400">${count}</p>
                        <p class="text-xs text-gray-500">${delivered.length} entregados / ${active.length} en curso</p>
                    </div>
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 text-center">
                        <p class="text-blue-400 text-sm font-medium">Ticket Promedio</p>
                        <p class="text-2xl font-bold text-blue-400">${fmt(avg)}</p>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-4 text-center">
                        <p class="text-purple-400 text-sm font-medium">Envios cobrados</p>
                        <p class="text-2xl font-bold text-purple-400">${fmt(totalDeliveryFees)}</p>
                        ${totalDiscounts > 0 ? `<p class="text-xs text-red-400">Desc: -${fmt(totalDiscounts)}</p>` : ''}
                    </div>
                    <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4 text-center">
                        <p class="text-red-400 text-sm font-medium">Cancelados</p>
                        <p class="text-2xl font-bold text-red-400">${cancelledOrders.length}</p>
                        <p class="text-xs text-gray-500">${fmt(cancelledTotal)} perdido</p>
                    </div>
                </div>

                <!-- Two columns -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- By delivery type -->
                    <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                        <h3 class="font-bold text-gray-300 mb-4">Por Tipo de Pedido</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between bg-white/5 rounded-lg p-3 border border-white/5">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">üöö</span>
                                    <div>
                                        <p class="font-semibold text-gray-200">Delivery</p>
                                        <p class="text-xs text-gray-500">${deliveryOrders.length} pedidos</p>
                                    </div>
                                </div>
                                <span class="font-bold text-lg text-white">${fmt(deliveryTotal)}</span>
                            </div>
                            <div class="flex items-center justify-between bg-white/5 rounded-lg p-3 border border-white/5">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">üè™</span>
                                    <div>
                                        <p class="font-semibold text-gray-200">Mostrador / Retira</p>
                                        <p class="text-xs text-gray-500">${pickupOrders.length} pedidos</p>
                                    </div>
                                </div>
                                <span class="font-bold text-lg text-white">${fmt(pickupTotal)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- By payment method -->
                    <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                        <h3 class="font-bold text-gray-300 mb-4">Por Medio de Pago</h3>
                        <div class="space-y-2">
                            ${Object.entries(byPayment).sort((a, b) => b[1].total - a[1].total).map(([method, data]) => `
                                <div class="flex items-center justify-between bg-white/5 rounded-lg p-3 border border-white/5">
                                    <div class="flex items-center space-x-2">
                                        <span>${PAY_ICONS[method] || 'üí∞'}</span>
                                        <div>
                                            <p class="font-medium text-sm text-gray-200">${PAY_LABELS[method] || method}</p>
                                            <p class="text-xs text-gray-500">${data.count} pedido${data.count > 1 ? 's' : ''}</p>
                                        </div>
                                    </div>
                                    <span class="font-bold text-white">${fmt(data.total)}</span>
                                </div>
                            `).join('')}
                            ${Object.keys(byPayment).length === 0 ? '<p class="text-gray-500 text-sm text-center py-4">Sin pedidos</p>' : ''}
                        </div>
                    </div>
                </div>

                <!-- Top Products -->
                ${topProducts.length > 0 ? `
                <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                    <h3 class="font-bold text-gray-300 mb-4">Productos mas vendidos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        ${topProducts.map(([name, qty], i) => `
                            <div class="bg-white/5 rounded-lg p-3 border border-white/5 text-center">
                                <p class="font-bold text-orange-400">${qty}</p>
                                <p class="text-xs text-gray-400 truncate" title="${name}">${name}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
            `;
        }

        async function printCierreCaja() {
            // Cierre de caja se visualiza en pantalla, no se imprime desde la web
            showToast('El cierre se muestra en pantalla. Para imprimir usa la app de impresion.', 'info');
        }

        // ==================== NOTIFICACION WHATSAPP ====================
        async function notifyCustomerWhatsApp(orderId, event, estimatedMinutes = null, cadeteName = null) {
            try {
                let order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    const { data } = await db.from('orders').select('*, customers(name, phone)').eq('id', orderId).single();
                    order = data;
                }
                if (!order) return;
                const phone = order.customers?.phone || (order.customer_notes?.match(/Tel: ([^|]+)/)?.[1]?.trim());
                if (!phone) return;
                const cleanPhone = phone.replace(/\D/g, '');
                const name = order.customers?.name || (order.customer_notes?.match(/Nombre: ([^|]+)/)?.[1]?.trim()) || '';

                let msg = '';
                if (event === 'confirmed') {
                    const timeText = estimatedMinutes ? ` Tiempo estimado: *${estimatedMinutes} minutos*.` : '';
                    msg = `Hola ${name}! Tu pedido #${order.order_number} fue *confirmado*.${timeText} Total: $${parseFloat(order.total).toLocaleString('es-AR')}. Gracias por elegir 7Tres7!`;
                } else if (event === 'ready') {
                    msg = order.delivery_type === 'pickup'
                        ? `Hola ${name}! Tu pedido #${order.order_number} esta *listo para retirar*. Te esperamos en Calle 18 N 737. Gracias!`
                        : `Hola ${name}! Tu pedido #${order.order_number} esta *listo* y sale en un ratito. Gracias por elegir 7Tres7!`;
                } else if (event === 'delivering') {
                    const cadeteText = cadeteName ? ` Lo lleva *${cadeteName}*.` : '';
                    msg = `Hola ${name}! Tu pedido #${order.order_number} ya *salio en camino*!${cadeteText} Llegamos en breve. Gracias por elegir 7Tres7!`;
                }

                if (msg) window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            } catch (e) { console.warn('Error notificando:', e); }
        }

        // ==================== HELPERS ====================
        function extractFromNotes(notes, field) {
            if (!notes) return '';
            const match = notes.match(new RegExp(field + ':\\s*([^|]+)'));
            return match ? match[1].trim() : '';
        }

        function showToast(msg, type = 'info') {
            const colors = { success: 'bg-green-500/90', error: 'bg-red-500/90', info: 'bg-blue-500/90' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg text-sm backdrop-blur-sm border border-white/10`;
            toast.textContent = msg;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== TIMER UPDATE ====================
        setInterval(() => {
            if (!appInitialized) return;
            // Update all visible timers using order data (dark theme colors)
            document.querySelectorAll('[data-order-id]').forEach(el => {
                const order = allOrders.find(o => o.id === el.dataset.orderId);
                if (!order) return;
                const ti = getTimeInfo(order);
                el.textContent = ti.label;
                el.className = `text-xs font-medium px-2 py-0.5 rounded-full ${ti.bg} ${ti.color} w-14 text-center ${ti.pulse ? 'timer-pulse' : ''}`;
            });
            // Update late badge & stats
            updateStats();
            // Update detail panel time if showing an active order
            if (selectedOrderId) {
                const order = allOrders.find(o => o.id === selectedOrderId);
                if (order && ['pending', 'confirmed', 'preparing', 'ready', 'delivering'].includes(order.status)) {
                    renderOrderDetail();
                }
            }
        }, 30000);

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.key === 'F2') {
                e.preventDefault();
                document.getElementById('search-input')?.focus();
            }
            if (e.key === 'F12') {
                e.preventDefault();
                openCierreCaja();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                selectedOrderId = null;
                deletingItemIndex = null;
                renderOrderDetail();
                renderOrderList();
                closeCierreCaja();
                closeAddItemModal();
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectNextOrder();
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectPrevOrder();
            }
            if (e.key === 'Enter' && selectedOrderId) {
                e.preventDefault();
                executeMainAction();
            }
            // Alt+1-4: switch mother tabs
            if (e.key >= '1' && e.key <= '4' && e.altKey) {
                e.preventDefault();
                const tabs = ['todos', 'mostrador', 'delivery', 'salon'];
                const idx = parseInt(e.key) - 1;
                if (idx < tabs.length) switchMotherTab(tabs[idx]);
            }
        });
    </script>
</body>
</html>
